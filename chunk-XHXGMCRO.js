import{a as Ve}from"./chunk-EFLDKXVB.js";import{a as Fe,b as $e,c as He}from"./chunk-XRIMUZWK.js";import{$ as Ge,A as K,B as F,C as M,D as u,E as h,F as S,G as Se,H as N,I as _,L as U,M as Pe,N as Be,O as m,P as te,Q as R,S as Le,T as Me,U as Te,Y as I,a as O,b as D,ba as Ke,c as p,d as B,g as w,h as Q,i as z,j as Ee,k as Ie,n as V,o as ee,t as d,u as ke,w as x,x as A,y as fe,z as J}from"./chunk-MNGWSI5C.js";var L=(t=>(t.RED="red",t.BLACK="black",t))(L||{});var C={BOARD_WIDTH:9,BOARD_HEIGHT:10,PALACE_WIDTH:3,PALACE_HEIGHT:3,PALACE_LEFT:3,PALACE_RIGHT:5,RED_PALACE_TOP:7,RED_PALACE_BOTTOM:9,BLACK_PALACE_TOP:0,BLACK_PALACE_BOTTOM:2,RIVER_POSITION:5,MAX_MOVE_HISTORY:500,AI_THINK_TIME_LIMIT:5e3,CACHE_SIZE:1e3,AI_THINKING_DELAY:500,CACHE_CLEANUP_INTERVAL:10};var ie={king:1e4,rook:600,cannon:300,horse:300,advisor:20,elephant:20,soldier:100},Oe={king:[[0,0,0,8888,8888,8888,0,0,0],[0,0,0,8888,8888,8888,0,0,0],[0,0,0,8888,8888,8888,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,-8888,-8888,-8888,0,0,0],[0,0,0,-8888,-8888,-8888,0,0,0],[0,0,0,-8888,-8888,-8888,0,0,0]],advisor:[[0,0,0,20,0,20,0,0,0],[0,0,0,0,23,0,0,0,0],[0,0,0,20,0,20,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,-20,0,-20,0,0,0],[0,0,0,0,-23,0,0,0,0],[0,0,0,-20,0,-20,0,0,0]],elephant:[[0,0,20,0,0,0,20,0,0],[0,0,0,0,0,0,0,0,0],[18,0,0,0,23,0,0,0,18],[0,0,0,0,0,0,0,0,0],[0,0,20,0,0,0,20,0,0],[0,0,-20,0,0,0,-20,0,0],[0,0,0,0,0,0,0,0,0],[-18,0,0,0,-23,0,0,0,-18],[0,0,0,0,0,0,0,0,0],[0,0,-20,0,0,0,-20,0,0]],rook:[[206,208,207,213,214,213,207,208,206],[206,212,209,216,233,216,209,212,206],[206,208,207,214,216,214,207,208,206],[206,213,213,216,216,216,213,213,206],[208,211,211,214,215,214,211,211,208],[208,212,212,214,215,214,212,212,208],[204,209,204,212,214,212,204,209,204],[198,208,204,212,212,212,204,208,198],[200,208,206,212,200,212,206,208,200],[194,206,204,212,200,212,204,206,194]],horse:[[90,90,90,96,103,96,90,90,90],[90,96,103,97,94,97,103,96,90],[92,98,99,103,99,103,99,98,92],[93,108,100,107,100,107,100,108,93],[90,100,99,103,104,103,99,100,90],[90,98,101,102,103,102,101,98,90],[92,94,98,95,98,95,98,94,92],[93,92,94,95,92,95,94,92,93],[85,90,92,93,78,93,92,90,85],[88,85,90,88,90,88,90,85,88]],cannon:[[100,100,96,91,90,91,96,100,100],[98,98,96,92,89,92,96,98,98],[97,97,96,91,92,91,96,97,97],[96,99,99,98,100,98,99,99,96],[96,96,96,96,100,96,96,96,96],[95,96,99,96,100,96,99,96,95],[96,96,96,96,96,96,96,96,96],[97,96,100,99,101,99,100,96,97],[96,97,98,98,98,98,98,97,96],[96,96,97,99,99,99,97,96,96]],soldier:[[9,9,9,11,13,11,9,9,9],[19,24,34,42,44,42,34,24,19],[19,24,32,37,37,37,32,24,19],[19,23,27,29,30,29,27,23,19],[14,18,20,27,29,27,20,18,14],[7,0,13,0,16,0,13,0,7],[7,0,7,0,15,0,7,0,7],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]]},T={DEPTHS:{easy:5,medium:10,hard:14},MAX_TIME:15e3,INFINITY:2e4,MATE_VALUE:1e4,CHECK_BONUS:150,MOBILITY_FACTOR:3},Y={CAPTURE_BONUS:1e3,KILLER_MOVE_BONUS:500,HISTORY_BONUS_MAX:100,POSITION_BONUS_FACTOR:10,CENTER_CONTROL_FACTOR:5},$={KING_SAFETY:{ADJACENT_PIECE_BONUS:5,FORTRESS_BONUS:10,EXPOSED_PENALTY:-20},PAWN_ADVANCEMENT:{CROSSED_RIVER_BONUS:15,ADVANCED_BONUS:10,PROMOTION_THREAT_BONUS:20},MOBILITY:{ROOK_MOBILITY_FACTOR:3,CANNON_MOBILITY_FACTOR:2,HORSE_MOBILITY_FACTOR:4,MIN_MOBILITY_BONUS:-10,MAX_MOBILITY_BONUS:30}};function Ue(n,e,t){let i=0,o=[[-1,0],[1,0],[0,-1],[0,1]];for(let[s,r]of o){let a=n.x+s,l=n.y+r;if(a>=0&&a<9&&l>=0&&l<10){let c=e[l][a];c&&c.color===t&&(i+=$.KING_SAFETY.ADJACENT_PIECE_BONUS)}}return i}function Ye(n,e){let t=0;return e==="black"?n.y>=5&&(t+=$.PAWN_ADVANCEMENT.CROSSED_RIVER_BONUS,t+=(n.y-5)*$.PAWN_ADVANCEMENT.ADVANCED_BONUS):n.y<=4&&(t+=$.PAWN_ADVANCEMENT.CROSSED_RIVER_BONUS,t+=(4-n.y)*$.PAWN_ADVANCEMENT.ADVANCED_BONUS),t}function je(n,e){let t=0;switch(n){case"rook":t=e*$.MOBILITY.ROOK_MOBILITY_FACTOR;break;case"cannon":t=e*$.MOBILITY.CANNON_MOBILITY_FACTOR;break;case"horse":t=e*$.MOBILITY.HORSE_MOBILITY_FACTOR;break;default:t=e}return Math.max($.MOBILITY.MIN_MOBILITY_BONUS,Math.min($.MOBILITY.MAX_MOBILITY_BONUS,t))}function oe(n,e,t,i){let o=ie[n];if(!Oe[n])return o;let s;if(i==="red"){let r=9-t;s=Oe[n][r][e]}else s=Oe[n][t][e];return o+s}var G=class{static ORTHOGONAL_DIRECTIONS=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}];static DIAGONAL_DIRECTIONS=[{dx:-1,dy:-1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:1,dy:1}];static isValidPosition(e,t){return e>=0&&e<C.BOARD_WIDTH&&t>=0&&t<C.BOARD_HEIGHT}static isInPalace(e,t,i){return i==="red"?e>=C.PALACE_LEFT&&e<=C.PALACE_RIGHT&&t>=C.RED_PALACE_TOP&&t<=C.RED_PALACE_BOTTOM:e>=C.PALACE_LEFT&&e<=C.PALACE_RIGHT&&t>=C.BLACK_PALACE_TOP&&t<=C.BLACK_PALACE_BOTTOM}static isOnOwnSide(e,t){return t==="red"?e>=5:e<=4}static isValidMoveForPiece(e,t,i){if(!this.isValidPosition(e.x,e.y))return!1;let o=i[e.y][e.x];return!o||o.color!==t.color}static getSlidingPieceMoves(e,t,i){let o=[],{x:s,y:r}=e.position;return i.forEach(a=>{for(let l=1;l<10;l++){let c=s+a.dx*l,f=r+a.dy*l;if(!this.isValidPosition(c,f))break;let g=t[f][c];if(g){g.color!==e.color&&o.push({x:c,y:f});break}else o.push({x:c,y:f})}}),o}static getKingMoves(e,t,i,o){let{x:s,y:r}=e.position;return this.ORTHOGONAL_DIRECTIONS.map(l=>({x:s+l.dx,y:r+l.dy})).filter(l=>{if(!this.isValidPosition(l.x,l.y)||!this.isInPalace(l.x,l.y,e.color))return!1;let c=t[l.y][l.x];return c&&c.color===e.color?!1:!i||!o?.(e,l,t)})}static getAdvisorMoves(e,t){let{x:i,y:o}=e.position;return this.DIAGONAL_DIRECTIONS.map(r=>({x:i+r.dx,y:o+r.dy})).filter(r=>this.isValidPosition(r.x,r.y)&&this.isInPalace(r.x,r.y,e.color)&&this.isValidMoveForPiece(r,e,t))}static getElephantMoves(e,t){let{x:i,y:o}=e.position;return[{x:i-2,y:o-2,block:{x:i-1,y:o-1}},{x:i+2,y:o-2,block:{x:i+1,y:o-1}},{x:i-2,y:o+2,block:{x:i-1,y:o+1}},{x:i+2,y:o+2,block:{x:i+1,y:o+1}}].filter(r=>this.isValidPosition(r.x,r.y)&&this.isOnOwnSide(r.y,e.color)&&!t[r.block.y][r.block.x]&&this.isValidMoveForPiece(r,e,t)).map(r=>({x:r.x,y:r.y}))}static getHorseMoves(e,t){let{x:i,y:o}=e.position;return[{x:i-1,y:o-2,block:{x:i,y:o-1}},{x:i+1,y:o-2,block:{x:i,y:o-1}},{x:i-1,y:o+2,block:{x:i,y:o+1}},{x:i+1,y:o+2,block:{x:i,y:o+1}},{x:i-2,y:o-1,block:{x:i-1,y:o}},{x:i-2,y:o+1,block:{x:i-1,y:o}},{x:i+2,y:o-1,block:{x:i+1,y:o}},{x:i+2,y:o+1,block:{x:i+1,y:o}}].filter(r=>this.isValidPosition(r.x,r.y)&&!t[r.block.y][r.block.x]&&this.isValidMoveForPiece(r,e,t)).map(r=>({x:r.x,y:r.y}))}static getRookMoves(e,t){return this.getSlidingPieceMoves(e,t,this.ORTHOGONAL_DIRECTIONS)}static getCannonMoves(e,t){let i=[],{x:o,y:s}=e.position;return this.ORTHOGONAL_DIRECTIONS.forEach(r=>{let a=!1;for(let l=1;l<10;l++){let c=o+r.dx*l,f=s+r.dy*l;if(!this.isValidPosition(c,f))break;let g=t[f][c];if(g)if(!a)a=!0;else{g.color!==e.color&&i.push({x:c,y:f});break}else a||i.push({x:c,y:f})}}),i}static getSoldierMoves(e,t){let i=[],{x:o,y:s}=e.position,r=e.color==="red"?-1:1,a={x:o,y:s+r};return this.isValidMoveForPiece(a,e,t)&&i.push(a),this.isOnOwnSide(s,e.color)||[{x:o-1,y:s},{x:o+1,y:s}].forEach(c=>{this.isValidMoveForPiece(c,e,t)&&i.push(c)}),i}static getPieceMoves(e,t,i=!0,o){switch(e.type){case"king":return this.getKingMoves(e,t,i,o);case"advisor":return this.getAdvisorMoves(e,t);case"elephant":return this.getElephantMoves(e,t);case"horse":return this.getHorseMoves(e,t);case"rook":return this.getRookMoves(e,t);case"cannon":return this.getCannonMoves(e,t);case"soldier":return this.getSoldierMoves(e,t);default:return[]}}};var pe=class{cache=new Map;maxSize;constructor(e=C.CACHE_SIZE){this.maxSize=e}get(e){let t=this.cache.get(e);return t!==void 0&&(this.cache.delete(e),this.cache.set(e,t)),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){let i=this.cache.keys().next().value;i!==void 0&&this.cache.delete(i)}this.cache.set(e,t)}has(e){return this.cache.has(e)}clear(){this.cache.clear()}get size(){return this.cache.size}get maxCapacity(){return this.maxSize}};var Z=class{static createEmptyCache(){return{kingPositions:new Map,piecesByColor:new Map([["red",[]],["black",[]]]),lastMoveCount:-1}}static resetCache(e){e.kingPositions.clear(),e.piecesByColor.clear(),e.piecesByColor.set("red",[]),e.piecesByColor.set("black",[]),e.lastMoveCount=-1}static needsUpdate(e,t){return e.lastMoveCount!==t}};var b=class{static isMoveLegal(e,t){let i=t.board,o=i[e.from.y][e.from.x];if(!o)return!1;let s=i[e.to.y][e.to.x],r=o.position;i[e.to.y][e.to.x]=o,i[e.from.y][e.from.x]=null,o.position=e.to;let a=this.isInCheck(i,o.color);return i[e.from.y][e.from.x]=o,i[e.to.y][e.to.x]=s,o.position=r,!a}static validateMoveWithRules(e,t,i){let o=t.board[e.from.y][e.from.x];if(!o||o.color!==i||!this.isMoveLegal(e,t))return!1;let s=this.simulateMove(t,e);return!this.isInCheck(s.board,i)}static isValidMove(e,t){return t.some(i=>i.from.x===e.from.x&&i.from.y===e.from.y&&i.to.x===e.to.x&&i.to.y===e.to.y)}static isInCheck(e,t){let i=null;for(let s=0;s<10;s++){for(let r=0;r<9;r++){let a=e[s][r];if(a&&a.type==="king"&&a.color===t){i={x:r,y:s};break}}if(i)break}if(!i)return!1;let o=t==="red"?"black":"red";for(let s=0;s<10;s++)for(let r=0;r<9;r++){let a=e[s][r];if(a&&a.color===o&&G.getPieceMoves(a,e,!1).some(c=>c.x===i.x&&c.y===i.y))return!0}return!1}static wouldKingsFaceEachOther(e){let t=null,i=null;for(let r=0;r<10;r++)for(let a=0;a<9;a++){let l=e[r][a];l&&l.type==="king"&&(l.color==="red"?t={x:a,y:r}:i={x:a,y:r})}if(!t||!i||t.x!==i.x)return!1;let o=Math.min(t.y,i.y),s=Math.max(t.y,i.y);for(let r=o+1;r<s;r++)if(e[r][t.x]!==null)return!1;return!0}static isCheckmate(e,t){if(!this.isInCheck(e,t))return!1;for(let i=0;i<10;i++)for(let o=0;o<9;o++){let s=e[i][o];if(s&&s.color===t){let r=G.getPieceMoves(s,e);for(let a of r){let l=e[a.y][a.x],c=s.position;e[a.y][a.x]=s,e[i][o]=null,s.position=a;let f=this.isInCheck(e,t);if(e[i][o]=s,e[a.y][a.x]=l,s.position=c,!f)return!1}}}return!0}static isStalemate(e,t){if(this.isInCheck(e,t))return!1;for(let i=0;i<10;i++)for(let o=0;o<9;o++){let s=e[i][o];if(s&&s.color===t&&G.getPieceMoves(s,e).length>0)return!1}return!0}static simulateMove(e,t){let i=e.board.map(s=>[...s]),o=i[t.from.y][t.from.x];return o&&(i[t.to.y][t.to.x]=D(O({},o),{position:{x:t.to.x,y:t.to.y},hasMoved:!0,isSelected:!1}),i[t.from.y][t.from.x]=null),D(O({},e),{board:i})}static getAllPossibleMoves(e,t){let i=[],o=e.board;for(let s=0;s<10;s++)for(let r=0;r<9;r++){let a=o[s][r];if(a&&a.color===t){let l=G.getPieceMoves(a,o);for(let c of l)i.push({from:a.position,to:c})}}return i}static getAllLegalMoves(e,t){return this.getAllPossibleMoves(e,t).filter(o=>this.isMoveLegal(o,e))}static getRandomLegalMove(e,t){let i=this.getAllLegalMoves(e,t);if(i.length===0)return null;let o=i.filter(r=>e.board[r.to.y][r.to.x]!==null),s=o.length>0?o:i;return s[Math.floor(Math.random()*s.length)]}static isInvalidMoveForAI(e,t,i,o){if(!i.board[e.from.y][e.from.x]||this.isInCheck(t.board,o)||this.wouldKingsFaceEachOther(t.board))return!0;let r=i.board[e.to.y][e.to.x];return r&&r.type==="king",!1}};var Re={board:[],currentPlayer:"red",selectedPiece:null,validMoves:[],status:{gameOver:!1,winner:null,isInCheck:!1,isSelfInCheck:!1,isCheckmate:!1,isStalemate:!1},moveHistory:[],isVsAI:!0,aiState:{isThinking:!1,thinkingText:""},hasApiKey:!1},j=class n{hasApiKey=V(!1);boardCache=Z.createEmptyCache();constructor(){this.updateApiKeyStatus()}moveCache=new pe;validatePosition(e,t,i="position"){if(!this.isValidPosition(e,t))throw new Error(`Invalid chess ${i}: (${e}, ${t}). Valid range: x[0-8], y[0-9]`)}validateBoard(e){if(!e||e.length!==C.BOARD_HEIGHT)throw new Error(`Invalid board height: expected ${C.BOARD_HEIGHT}`);for(let t=0;t<e.length;t++)if(!e[t]||e[t].length!==C.BOARD_WIDTH)throw new Error(`Invalid board width at row ${t}: expected ${C.BOARD_WIDTH}`)}initializeBoard(){let e=Array(C.BOARD_HEIGHT).fill(null).map(()=>Array(C.BOARD_WIDTH).fill(null));return this.setupInitialPieces(e),e}setupInitialPieces(e){let t=["rook","horse","elephant","advisor","king","advisor","elephant","horse","rook"];t.forEach((o,s)=>{let r=this.generatePieceId(o,"red",s);e[9][s]=this.createPiece(r,o,"red",s,9)}),[...t].forEach((o,s)=>{let r=this.generatePieceId(o,"black",s);e[0][s]=this.createPiece(r,o,"black",s,0)}),[1,7].forEach((o,s)=>{e[7][o]=this.createPiece(`r-cannon-${s+1}`,"cannon","red",o,7),e[2][o]=this.createPiece(`b-cannon-${s+1}`,"cannon","black",o,2)});for(let o=0;o<9;o+=2)e[6][o]=this.createPiece(`r-soldier-${o}`,"soldier","red",o,6),e[3][o]=this.createPiece(`b-soldier-${o}`,"soldier","black",o,3)}generatePieceId(e,t,i){let o=t==="red"?"r":"b";return e==="king"?`${o}-king`:`${o}-${e}-${i<4?"1":"2"}`}createPiece(e,t,i,o,s){return{id:e,type:t,color:i,position:{x:o,y:s},isSelected:!1,hasMoved:!1}}initializeGameState(){return D(O({},Re),{board:this.initializeBoard(),hasApiKey:this.checkHasApiKey()})}isValidPosition(e,t){return e>=0&&e<C.BOARD_WIDTH&&t>=0&&t<C.BOARD_HEIGHT}isInPalace(e,t,i){return i==="red"?e>=C.PALACE_LEFT&&e<=C.PALACE_RIGHT&&t>=C.RED_PALACE_TOP&&t<=C.RED_PALACE_BOTTOM:e>=C.PALACE_LEFT&&e<=C.PALACE_RIGHT&&t>=C.BLACK_PALACE_TOP&&t<=C.BLACK_PALACE_BOTTOM}isOnOwnSide(e,t){return t==="red"?e>=5:e<=4}wouldKingsFaceEachOther(e,t=0){this.updateBoardCache(e,t);let i=this.boardCache.kingPositions.get("red"),o=this.boardCache.kingPositions.get("black");return!i||!o||i.x!==o.x||!this.isValidPosition(i.x,i.y)||!this.isValidPosition(o.x,o.y)?!1:this.isPathClear(e,i,o)}isPathClear(e,t,i){let o=Math.min(t.y,i.y),s=Math.max(t.y,i.y);for(let r=o+1;r<s;r++)if(e[r][t.x]!==null)return!1;return!0}updateBoardCache(e,t){if(Z.needsUpdate(this.boardCache,t)){Z.resetCache(this.boardCache);for(let i=0;i<C.BOARD_HEIGHT;i++)for(let o=0;o<C.BOARD_WIDTH;o++){let s=e[i][o];s&&(this.boardCache.piecesByColor.get(s.color).push(s),s.type==="king"&&this.boardCache.kingPositions.set(s.color,{x:o,y:i}))}this.boardCache.lastMoveCount=t}}clearCaches(){this.moveCache.clear(),Z.resetCache(this.boardCache)}getBoardHash(e){let t="";for(let i=0;i<C.BOARD_HEIGHT;i++)for(let o=0;o<C.BOARD_WIDTH;o++){let s=e[i][o];t+=s?`${s.type}${s.color}${o}${i}`:"e"}return t}getPossibleMoves(e,t){if(!e)throw new Error("Cannot get possible moves for null piece");this.validateBoard(t),this.validatePosition(e.position.x,e.position.y,"piece position");let i=`${e.id}-${e.position.x}-${e.position.y}-${e.hasMoved}-true`;if(this.moveCache.has(i))return this.moveCache.get(i);let o=this.calculatePieceMoves(e,t,!0);return this.moveCache.set(i,o),o}getPossibleMovesForCheck(e,t){if(!e)throw new Error("Cannot get possible moves for null piece");this.validateBoard(t),this.validatePosition(e.position.x,e.position.y,"piece position");let i=`${e.id}-${e.position.x}-${e.position.y}-${e.hasMoved}-false`;if(this.moveCache.has(i))return this.moveCache.get(i);let o=this.calculatePieceMoves(e,t,!1);return this.moveCache.set(i,o),o}calculatePieceMoves(e,t,i){return G.getPieceMoves(e,t,i,i?this.wouldMoveCreateKingFacing.bind(this):void 0)}wouldMoveCreateKingFacing(e,t,i){let o=i[t.y][t.x],s=e.position;i[t.y][t.x]=e,i[s.y][s.x]=null,e.position=t;let r=this.wouldKingsFaceEachOther(i);return i[s.y][s.x]=e,i[t.y][t.x]=o,e.position=s,r}isInCheck(e,t,i=0){return b.isInCheck(e,t)}makeMove(e,t,i){this.validatePosition(t.x,t.y,"source position"),this.validatePosition(i.x,i.y,"target position"),this.validateBoard(e.board);let{board:o,moveHistory:s}=e,r=o[t.y][t.x];if(!r)return{success:!1,status:{gameOver:!1,winner:null,isInCheck:!1,isSelfInCheck:!1,isCheckmate:!1,isStalemate:!1}};let a=o[i.y][i.x],l=s.length;if(this.clearCaches(),o[i.y][i.x]=r,o[t.y][t.x]=null,r.position=i,a&&a.type==="king")return r.hasMoved=!0,{success:!0,captured:a,status:{gameOver:!0,winner:r.color,winReason:"\u5403\u6389\u5C0D\u65B9\u7684\u738B",isInCheck:!1,isSelfInCheck:!1,isCheckmate:!0,isStalemate:!1}};if(this.wouldKingsFaceEachOther(o,l+1))return r.hasMoved=!0,console.log(`\u{1F534} \u738B\u898B\u738B\uFF01${r.color==="red"?"\u7D05\u65B9":"\u9ED1\u65B9"} \u6557\u5317\uFF01`),{success:!0,captured:a||void 0,status:{gameOver:!0,winner:r.color==="red"?"black":"red",winReason:"\u5C0D\u65B9\u9020\u6210\u738B\u898B\u738B",isInCheck:!1,isSelfInCheck:!1,isCheckmate:!0,isStalemate:!1}};let c=r.color==="red"?"black":"red",f=this.isInCheck(o,c,l+1),g=this.isInCheck(o,r.color,l+1);r.hasMoved=!0;let v=f?this.isCheckmate(o,c,l+1):!1,y=f?!1:this.isStalemate(o,c,l+1);return{success:!0,captured:a||void 0,status:{gameOver:v||y,winner:v?r.color:null,winReason:v?"\u5C07\u6B7B\u5C0D\u65B9":y?"\u548C\u68CB":void 0,isInCheck:f,isSelfInCheck:g,isCheckmate:v,isStalemate:y}}}getPieceSymbol(e){return{king:{red:"\u5E25",black:"\u5C07"},advisor:{red:"\u4ED5",black:"\u58EB"},elephant:{red:"\u76F8",black:"\u8C61"},horse:{red:"\u99AC",black:"\u99AC"},rook:{red:"\u8ECA",black:"\u8ECA"},cannon:{red:"\u70AE",black:"\u7832"},soldier:{red:"\u5175",black:"\u5352"}}[e.type][e.color]}checkHasApiKey(){if(typeof localStorage<"u"){let e=localStorage.getItem("gemini-api-key");return!!e&&e!=="YOUR_GEMINI_API_KEY_HERE"}return!1}updateApiKeyStatus(){let e=this.checkHasApiKey();this.hasApiKey.set(e)}isStalemate(e,t,i=0){return b.isStalemate(e,t)}isCheckmate(e,t,i=0){return b.isCheckmate(e,t)}isPerpetualCheck(e,t=3){if(e.length<t*2)return!1;let i=e.slice(-t*2),o=i.slice(0,2);for(let s=2;s<i.length;s+=2)if(i[s]!==o[0]||i[s+1]!==o[1])return!1;return!0}getAllPossibleMoves(e,t){return b.getAllPossibleMoves(e,t)}getAllLegalMoves(e,t){return b.getAllLegalMoves(e,t)}isMoveLegal(e,t){return b.isMoveLegal(e,t)}simulateMove(e,t){return b.simulateMove(e,t)}validateMoveWithRules(e,t,i){return b.validateMoveWithRules(e,t,i)}getRandomLegalMove(e,t){return b.getRandomLegalMove(e,t)}isValidMove(e,t){return b.isValidMove(e,t)}makeAIMove(e,t){return p(this,null,function*(){try{if(!(yield t.isAvailable()))return this.handleAIMoveFallback(e,"AI \u7B56\u7565\u4E0D\u53EF\u7528");let o=yield t.makeMove(e);if(!o)return this.handleAIMoveFallback(e,"AI \u7B56\u7565\u672A\u8FD4\u56DE\u6709\u6548\u79FB\u52D5");let{from:s,to:r}=o,a=e.board[s.y][s.x];if(!a)return this.handleAIMoveFallback(e,`\u4F4D\u7F6E (${s.x},${s.y}) \u6C92\u6709\u68CB\u5B50`);if(a.color!=="black")return this.handleAIMoveFallback(e,"AI \u5617\u8A66\u79FB\u52D5\u975E\u9ED1\u65B9\u68CB\u5B50");let l=this.getPossibleMoves(a,e.board);return this.isValidMove({from:s,to:r},l.map(c=>({from:a.position,to:c})))?b.isMoveLegal({from:s,to:r},e)?(console.log(`\u2705 AI \u79FB\u52D5\u9A57\u8B49\u901A\u904E: (${s.x},${s.y}) -> (${r.x},${r.y})`),this.makeMove(e,s,r)):this.handleAIMoveFallback(e,`\u79FB\u52D5 (${s.x},${s.y}) -> (${r.x},${r.y}) \u6703\u5C0E\u81F4\u9001\u6B7B\u6216\u738B\u898B\u738B`):this.handleAIMoveFallback(e,`\u79FB\u52D5 (${s.x},${s.y}) -> (${r.x},${r.y}) \u4E0D\u5728\u53EF\u80FD\u79FB\u52D5\u5217\u8868\u4E2D`)}catch(i){return console.error("\u274C AI \u79FB\u52D5\u57F7\u884C\u5931\u6557:",i),this.handleAIMoveFallback(e,`AI \u57F7\u884C\u932F\u8AA4: ${i}`)}})}handleAIMoveFallback(e,t){console.warn(`\u26A0\uFE0F AI \u79FB\u52D5\u5931\u6557: ${t}`),console.log("\u{1F3B2} \u4F7F\u7528\u96A8\u6A5F\u5408\u6CD5\u79FB\u52D5\u4F5C\u70BA\u5099\u6848...");let i=b.getRandomLegalMove(e,"black");return i?(console.log(`\u{1F3AF} \u5099\u7528\u79FB\u52D5: (${i.from.x},${i.from.y}) -> (${i.to.x},${i.to.y})`),this.makeMove(e,i.from,i.to)):(console.error("\u274C \u6C92\u6709\u53EF\u7528\u7684\u5408\u6CD5\u79FB\u52D5\uFF0CAI \u7121\u6CD5\u884C\u52D5"),{success:!1,captured:void 0,status:e.status})}convertToFEN(e){let t=e.board,i=[];for(let r=0;r<C.BOARD_HEIGHT;r++){let a="",l=0;for(let c=0;c<C.BOARD_WIDTH;c++){let f=t[r][c];f?(l>0&&(a+=l.toString(),l=0),a+=this.pieceToFEN(f)):l++}l>0&&(a+=l.toString()),i.push(a)}let o=i.join("/"),s=e.currentPlayer==="red"?"w":"b";return`${o} ${s}`}pieceToFEN(e){let i={king:"k",advisor:"a",elephant:"b",horse:"n",rook:"r",cannon:"c",soldier:"p"}[e.type];return e.color==="red"?i.toUpperCase():i.toLowerCase()}static \u0275fac=function(t){return new(t||n)};static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var q=class{};var qe=["user","model","function","system"];var ge=(function(n){return n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.OTHER="OTHER",n})(ge||{});var P=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},W=class extends P{constructor(e,t){super(e),this.response=t}},Ce=class extends P{constructor(e,t,i,o){super(e),this.status=t,this.statusText=i,this.errorDetails=o}},H=class extends P{},ye=class extends P{};var st="https://generativelanguage.googleapis.com",rt="v1beta",at="0.24.1",lt="genai-js",se=(function(n){return n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents",n})(se||{}),De=class{constructor(e,t,i,o,s){this.model=e,this.task=t,this.apiKey=i,this.stream=o,this.requestOptions=s}toString(){var e,t;let i=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||rt,s=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||st}/${i}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}};function ct(n){let e=[];return n?.apiClient&&e.push(n.apiClient),e.push(`${lt}/${at}`),e.join(" ")}function ut(n){return p(this,null,function*(){var e;let t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",ct(n.requestOptions)),t.append("x-goog-api-key",n.apiKey);let i=(e=n.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(i){if(!(i instanceof Headers))try{i=new Headers(i)}catch(o){throw new H(`unable to convert customHeaders value ${JSON.stringify(i)} to Headers: ${o.message}`)}for(let[o,s]of i.entries()){if(o==="x-goog-api-key")throw new H(`Cannot set reserved header name ${o}`);if(o==="x-goog-api-client")throw new H(`Header name ${o} can only be set using the apiClient field`);t.append(o,s)}}return t})}function dt(n,e,t,i,o,s){return p(this,null,function*(){let r=new De(n,e,t,i,s);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},pt(s)),{method:"POST",headers:yield ut(r),body:o})}})}function le(a,l,c,f,g){return p(this,arguments,function*(n,e,t,i,o,s={},r=fetch){let{url:v,fetchOptions:y}=yield dt(n,e,t,i,o,s);return ht(v,y,r)})}function ht(i,o){return p(this,arguments,function*(n,e,t=fetch){let s;try{s=yield t(n,e)}catch(r){ft(r,n)}return s.ok||(yield mt(s,n)),s})}function ft(n,e){let t=n;throw t.name==="AbortError"?(t=new ye(`Request aborted when fetching ${e.toString()}: ${n.message}`),t.stack=n.stack):n instanceof Ce||n instanceof H||(t=new P(`Error fetching from ${e.toString()}: ${n.message}`),t.stack=n.stack),t}function mt(n,e){return p(this,null,function*(){let t="",i;try{let o=yield n.json();t=o.error.message,o.error.details&&(t+=` ${JSON.stringify(o.error.details)}`,i=o.error.details)}catch{}throw new Ce(`Error fetching from ${e.toString()}: [${n.status} ${n.statusText}] ${t}`,n.status,n.statusText,i)})}function pt(n){let e={};if(n?.signal!==void 0||n?.timeout>=0){let t=new AbortController;n?.timeout>=0&&setTimeout(()=>t.abort(),n.timeout),n?.signal&&n.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function Ne(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),ve(n.candidates[0]))throw new W(`${X(n)}`,n);return gt(n)}else if(n.promptFeedback)throw new W(`Text not available. ${X(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ve(n.candidates[0]))throw new W(`${X(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),We(n)[0]}else if(n.promptFeedback)throw new W(`Function call not available. ${X(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ve(n.candidates[0]))throw new W(`${X(n)}`,n);return We(n)}else if(n.promptFeedback)throw new W(`Function call not available. ${X(n)}`,n)},n}function gt(n){var e,t,i,o;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let r of(o=(i=n.candidates)===null||i===void 0?void 0:i[0].content)===null||o===void 0?void 0:o.parts)r.text&&s.push(r.text),r.executableCode&&s.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&s.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return s.length>0?s.join(""):""}function We(n){var e,t,i,o;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let r of(o=(i=n.candidates)===null||i===void 0?void 0:i[0].content)===null||o===void 0?void 0:o.parts)r.functionCall&&s.push(r.functionCall);if(s.length>0)return s}var vt=[ge.RECITATION,ge.SAFETY,ge.LANGUAGE];function ve(n){return!!n.finishReason&&vt.includes(n.finishReason)}function X(n){var e,t,i;let o="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)o+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(o+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(o+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((i=n.candidates)===null||i===void 0)&&i[0]){let s=n.candidates[0];ve(s)&&(o+=`Candidate was blocked due to ${s.finishReason}`,s.finishMessage&&(o+=`: ${s.finishMessage}`))}return o}function re(n){return this instanceof re?(this.v=n,this):new re(n)}function Ct(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),o,s=[];return o={},r("next"),r("throw"),r("return"),o[Symbol.asyncIterator]=function(){return this},o;function r(v){i[v]&&(o[v]=function(y){return new Promise(function(E,k){s.push([v,y,E,k])>1||a(v,y)})})}function a(v,y){try{l(i[v](y))}catch(E){g(s[0][3],E)}}function l(v){v.value instanceof re?Promise.resolve(v.value.v).then(c,f):g(s[0][2],v)}function c(v){a("next",v)}function f(v){a("throw",v)}function g(v,y){v(y),s.shift(),s.length&&a(s[0][0],s[0][1])}}var Xe=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function yt(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=xt(e),[i,o]=t.tee();return{stream:_t(i),response:bt(o)}}function bt(n){return p(this,null,function*(){let e=[],t=n.getReader();for(;;){let{done:i,value:o}=yield t.read();if(i)return Ne(At(e));e.push(o)}})}function _t(n){return Ct(this,arguments,function*(){let t=n.getReader();for(;;){let{value:i,done:o}=yield re(t.read());if(o)break;yield yield re(Ne(i))}})}function xt(n){let e=n.getReader();return new ReadableStream({start(i){let o="";return s();function s(){return e.read().then(({value:r,done:a})=>{if(a){if(o.trim()){i.error(new P("Failed to parse stream"));return}i.close();return}o+=r;let l=o.match(Xe),c;for(;l;){try{c=JSON.parse(l[1])}catch{i.error(new P(`Error parsing JSON response: "${l[1]}"`));return}i.enqueue(c),o=o.substring(l[0].length),l=o.match(Xe)}return s()}).catch(r=>{let a=r;throw a.stack=r.stack,a.name==="AbortError"?a=new ye("Request aborted when reading from the stream"):a=new P("Error reading from the stream"),a})}}})}function At(n){let e=n[n.length-1],t={promptFeedback:e?.promptFeedback};for(let i of n){if(i.candidates){let o=0;for(let s of i.candidates)if(t.candidates||(t.candidates=[]),t.candidates[o]||(t.candidates[o]={index:o}),t.candidates[o].citationMetadata=s.citationMetadata,t.candidates[o].groundingMetadata=s.groundingMetadata,t.candidates[o].finishReason=s.finishReason,t.candidates[o].finishMessage=s.finishMessage,t.candidates[o].safetyRatings=s.safetyRatings,s.content&&s.content.parts){t.candidates[o].content||(t.candidates[o].content={role:s.content.role||"user",parts:[]});let r={};for(let a of s.content.parts)a.text&&(r.text=a.text),a.functionCall&&(r.functionCall=a.functionCall),a.executableCode&&(r.executableCode=a.executableCode),a.codeExecutionResult&&(r.codeExecutionResult=a.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),t.candidates[o].content.parts.push(r)}o++}i.usageMetadata&&(t.usageMetadata=i.usageMetadata)}return t}function et(n,e,t,i){return p(this,null,function*(){let o=yield le(e,se.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),i);return yt(o)})}function tt(n,e,t,i){return p(this,null,function*(){let s=yield(yield le(e,se.GENERATE_CONTENT,n,!1,JSON.stringify(t),i)).json();return{response:Ne(s)}})}function it(n){if(n!=null){if(typeof n=="string")return{role:"system",parts:[{text:n}]};if(n.text)return{role:"system",parts:[n]};if(n.parts)return n.role?n:{role:"system",parts:n.parts}}}function ae(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(let t of n)typeof t=="string"?e.push({text:t}):e.push(t);return Et(e)}function Et(n){let e={role:"user",parts:[]},t={role:"function",parts:[]},i=!1,o=!1;for(let s of n)"functionResponse"in s?(t.parts.push(s),o=!0):(e.parts.push(s),i=!0);if(i&&o)throw new P("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!i&&!o)throw new P("No content is provided for sending chat message.");return i?e:t}function It(n,e){var t;let i={model:e?.model,generationConfig:e?.generationConfig,safetySettings:e?.safetySettings,tools:e?.tools,toolConfig:e?.toolConfig,systemInstruction:e?.systemInstruction,cachedContent:(t=e?.cachedContent)===null||t===void 0?void 0:t.name,contents:[]},o=n.generateContentRequest!=null;if(n.contents){if(o)throw new H("CountTokensRequest must have one of contents or generateContentRequest, not both.");i.contents=n.contents}else if(o)i=Object.assign(Object.assign({},i),n.generateContentRequest);else{let s=ae(n);i.contents=[s]}return{generateContentRequest:i}}function Qe(n){let e;return n.contents?e=n:e={contents:[ae(n)]},n.systemInstruction&&(e.systemInstruction=it(n.systemInstruction)),e}function St(n){return typeof n=="string"||Array.isArray(n)?{content:ae(n)}:n}var ze=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],Pt={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function Mt(n){let e=!1;for(let t of n){let{role:i,parts:o}=t;if(!e&&i!=="user")throw new P(`First content should be with role 'user', got ${i}`);if(!qe.includes(i))throw new P(`Each item should include role field. Got ${i} but valid roles are: ${JSON.stringify(qe)}`);if(!Array.isArray(o))throw new P("Content should have 'parts' property with an array of Parts");if(o.length===0)throw new P("Each Content should have at least one part");let s={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let a of o)for(let l of ze)l in a&&(s[l]+=1);let r=Pt[i];for(let a of ze)if(!r.includes(a)&&s[a]>0)throw new P(`Content with role '${i}' can't contain '${a}' part`);e=!0}}function Je(n){var e;if(n.candidates===void 0||n.candidates.length===0)return!1;let t=(e=n.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(let i of t.parts)if(i===void 0||Object.keys(i).length===0||i.text!==void 0&&i.text==="")return!1;return!0}var Ze="SILENT_ERROR",we=class{constructor(e,t,i,o={}){this.model=t,this.params=i,this._requestOptions=o,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,i?.history&&(Mt(i.history),this._history=i.history)}getHistory(){return p(this,null,function*(){return yield this._sendPromise,this._history})}sendMessage(i){return p(this,arguments,function*(e,t={}){var o,s,r,a,l,c;yield this._sendPromise;let f=ae(e),g={safetySettings:(o=this.params)===null||o===void 0?void 0:o.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(r=this.params)===null||r===void 0?void 0:r.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,f]},v=Object.assign(Object.assign({},this._requestOptions),t),y;return this._sendPromise=this._sendPromise.then(()=>tt(this._apiKey,this.model,g,v)).then(E=>{var k;if(Je(E.response)){this._history.push(f);let he=Object.assign({parts:[],role:"model"},(k=E.response.candidates)===null||k===void 0?void 0:k[0].content);this._history.push(he)}else{let he=X(E.response);he&&console.warn(`sendMessage() was unsuccessful. ${he}. Inspect response object for details.`)}y=E}).catch(E=>{throw this._sendPromise=Promise.resolve(),E}),yield this._sendPromise,y})}sendMessageStream(i){return p(this,arguments,function*(e,t={}){var o,s,r,a,l,c;yield this._sendPromise;let f=ae(e),g={safetySettings:(o=this.params)===null||o===void 0?void 0:o.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(r=this.params)===null||r===void 0?void 0:r.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,f]},v=Object.assign(Object.assign({},this._requestOptions),t),y=et(this._apiKey,this.model,g,v);return this._sendPromise=this._sendPromise.then(()=>y).catch(E=>{throw new Error(Ze)}).then(E=>E.response).then(E=>{if(Je(E)){this._history.push(f);let k=Object.assign({},E.candidates[0].content);k.role||(k.role="model"),this._history.push(k)}else{let k=X(E);k&&console.warn(`sendMessageStream() was unsuccessful. ${k}. Inspect response object for details.`)}}).catch(E=>{E.message!==Ze&&console.error(E)}),y})}};function Tt(n,e,t,i){return p(this,null,function*(){return(yield le(e,se.COUNT_TOKENS,n,!1,JSON.stringify(t),i)).json()})}function Ot(n,e,t,i){return p(this,null,function*(){return(yield le(e,se.EMBED_CONTENT,n,!1,JSON.stringify(t),i)).json()})}function Rt(n,e,t,i){return p(this,null,function*(){let o=t.requests.map(r=>Object.assign(Object.assign({},r),{model:e}));return(yield le(e,se.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:o}),i)).json()})}var be=class{constructor(e,t,i={}){this.apiKey=e,this._requestOptions=i,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=it(t.systemInstruction),this.cachedContent=t.cachedContent}generateContent(i){return p(this,arguments,function*(e,t={}){var o;let s=Qe(e),r=Object.assign(Object.assign({},this._requestOptions),t);return tt(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(o=this.cachedContent)===null||o===void 0?void 0:o.name},s),r)})}generateContentStream(i){return p(this,arguments,function*(e,t={}){var o;let s=Qe(e),r=Object.assign(Object.assign({},this._requestOptions),t);return et(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(o=this.cachedContent)===null||o===void 0?void 0:o.name},s),r)})}startChat(e){var t;return new we(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}countTokens(i){return p(this,arguments,function*(e,t={}){let o=It(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return Tt(this.apiKey,this.model,o,s)})}embedContent(i){return p(this,arguments,function*(e,t={}){let o=St(e),s=Object.assign(Object.assign({},this._requestOptions),t);return Ot(this.apiKey,this.model,o,s)})}batchEmbedContents(i){return p(this,arguments,function*(e,t={}){let o=Object.assign(Object.assign({},this._requestOptions),t);return Rt(this.apiKey,this.model,e,o)})}};var _e=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new P("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new be(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,i){if(!e.name)throw new H("Cached content must contain a `name` field.");if(!e.model)throw new H("Cached content must contain a `model` field.");let o=["model","systemInstruction"];for(let r of o)if(t?.[r]&&e[r]&&t?.[r]!==e[r]){if(r==="model"){let a=t.model.startsWith("models/")?t.model.replace("models/",""):t.model,l=e.model.startsWith("models/")?e.model.replace("models/",""):e.model;if(a===l)continue}throw new H(`Different value for "${r}" specified in modelParams (${t[r]}) and cachedContent (${e[r]})`)}let s=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new be(this.apiKey,s,i)}};var ce=class n extends q{name="Gemini AI";priority=2;isAvailable(){return p(this,null,function*(){let e=typeof localStorage<"u"?localStorage.getItem("gemini-api-key"):null;return!!(e&&e!=="YOUR_GEMINI_API_KEY_HERE")})}makeMove(e){return p(this,null,function*(){try{let i=typeof localStorage<"u"?localStorage.getItem("gemini-api-key"):null;if(!i||i==="YOUR_GEMINI_API_KEY_HERE")return console.log("\u274C Gemini API Key \u672A\u8A2D\u7F6E\uFF0C\u8ACB\u5728\u8A2D\u5B9A\u4E2D\u8F38\u5165 API Key"),null;console.log("\u{1F511} \u4F7F\u7528 API Key:",i?`${i.substring(0,8)}...${i.substring(i.length-4)}`:"\u7121");let s=new _e(i).getGenerativeModel({model:"gemini-2.5-pro"});console.log("\u{1F4E1} \u6E96\u5099\u547C\u53EB Gemini API...");let r=this.createGeminiPrompt(e);console.log("\u{1F680} \u6B63\u5728\u547C\u53EB Gemini API...");let a=yield s.generateContent(r);console.log("\u2705 Gemini API \u547C\u53EB\u6210\u529F\uFF01");let c=(yield a.response).text();if(console.log("\u{1F4DD} Gemini \u56DE\u61C9\u9577\u5EA6:",c?.length||0),!c)return console.log("\u274C Gemini \u6C92\u6709\u8FD4\u56DE\u6709\u6548\u56DE\u61C9"),null;let f=c.match(/\{[\s\S]*\}/);if(f)try{let g=JSON.parse(f[0]);if(!this.isValidGeminiResponse(g))return console.warn("\u274C Gemini \u56DE\u61C9\u683C\u5F0F\u7121\u6548"),null;console.log("\u{1F916} Gemini \u5206\u6790:",g.analysis),console.log("\u{1F916} \u9078\u64C7\u7406\u7531:",g.reasoning);let v=this.getAllPossibleMoves(e,"black"),y=g.move;if(this.isValidMove(y,v))return{from:y.from,to:y.to,analysis:`${g.analysis} - ${g.reasoning}`};console.log("\u274C Gemini \u63D0\u4F9B\u7684\u79FB\u52D5\u7121\u6548")}catch(g){return console.error("\u274C \u7121\u6CD5\u89E3\u6790 Gemini JSON \u56DE\u61C9:",g),null}}catch(t){console.error("\u274C Gemini API \u8ABF\u7528\u5931\u6557:",t)}return null})}getThinkingDescription(){return"\u{1F916} Gemini AI \u6B63\u5728\u5206\u6790\u68CB\u5C40..."}createGeminiPrompt(e){let t=this.describeBoardState(e),i=this.getAllPossibleMoves(e,"black"),o=this.describeValidMoves(i);return`
You are a professional Chinese Chess AI. Please analyze the current board state and choose the best move.

Board state (RED at bottom, BLACK at top, coordinates start from 0,0):
${t}

Available moves:
${o}

Please analyze the position and choose the best move. Response must be in JSON format:
{
  "analysis": "Your analysis process",
  "move": {
    "from": {"x": start_x_coordinate, "y": start_y_coordinate},
    "to": {"x": target_x_coordinate, "y": target_y_coordinate}
  },
  "reasoning": "Reason for choosing this move"
}

Important notes:
1. You are BLACK player, choose moves that benefit BLACK
2. Coordinate system: x is column (0-8), y is row (0-9)
3. You can only choose from the provided available moves
4. Priority: capturing, checking, position improvement, defense
5. You have maximum 10 seconds thinking time
6. Please respond in Traditional Chinese
`}describeBoardState(e){let t="";for(let i=0;i<10;i++){let o=`Row ${i}: `;for(let s=0;s<9;s++){let r=e.board[i][s];if(r){let a=r.color==="red"?"RED":"BLACK";o+=`(${s},${i}):${a}_${r.type} `}}t+=o+`
`}return t}describeValidMoves(e){return e.map((t,i)=>`${i+1}. Move from (${t.from.x},${t.from.y}) to (${t.to.x},${t.to.y})`).join(`
`)}isValidGeminiResponse(e){return e&&typeof e=="object"&&e.move&&typeof e.move=="object"&&e.move.from&&typeof e.move.from=="object"&&typeof e.move.from.x=="number"&&typeof e.move.from.y=="number"&&e.move.to&&typeof e.move.to=="object"&&typeof e.move.to.x=="number"&&typeof e.move.to.y=="number"&&typeof e.analysis=="string"&&typeof e.reasoning=="string"}getAllPossibleMoves(e,t){return b.getAllPossibleMoves(e,t).map(o=>({from:{x:o.from.x,y:o.from.y},to:{x:o.to.x,y:o.to.y}}))}isValidMove(e,t){return b.isValidMove({from:e.from,to:e.to},t.map(i=>({from:i.from,to:i.to})))}static \u0275fac=(()=>{let e;return function(i){return(e||(e=ee(n)))(i||n)}})();static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var ue=class n extends q{name="XQWLight \u5C08\u696D\u5F15\u64CE";priority=1;searchDepth=T.DEPTHS.medium;startTime=0;nodeCount=0;killerMoves=new Map;historyTable=new Map;isAvailable(){return p(this,null,function*(){return!0})}makeMove(e){return p(this,null,function*(){console.log(`\u{1F525} \u4F7F\u7528 XQWLight \u5C08\u696D\u5F15\u64CE (\u6DF1\u5EA6${this.searchDepth})...`),this.startTime=Date.now(),this.nodeCount=0;try{let t=this.searchRoot(e,this.searchDepth),i=Date.now()-this.startTime;if(t)return console.log(`\u{1F3C6} XQWLight \u5206\u6790\u5B8C\u6210: ${i}ms, \u641C\u7D22${this.nodeCount}\u500B\u7BC0\u9EDE, \u8A55\u5206=${t.score}`),console.log(`\u{1F3AF} \u9078\u64C7\u79FB\u52D5: (${t.move.from.x},${t.move.from.y}) -> (${t.move.to.x},${t.move.to.y})`),{from:t.move.from,to:t.move.to,score:t.score,analysis:`XQWLight \u5C08\u696D\u5F15\u64CE \u6DF1\u5EA6${this.searchDepth}, ${this.nodeCount}\u7BC0\u9EDE, ${i}ms`};console.warn("\u26A0\uFE0F XQWLight \u641C\u7D22\u5931\u6557\uFF0C\u4F7F\u7528\u7C21\u55AE\u7B56\u7565");let o=this.getFallbackMove(e);return o?{from:o.from,to:o.to,score:0,analysis:"XQWLight \u5099\u7528\u7B56\u7565"}:null}catch(t){return console.error("\u274C XQWLight \u7B56\u7565\u57F7\u884C\u5931\u6557:",t),null}})}getThinkingDescription(){return`\u{1F525} XQWLight \u5C08\u696D\u5F15\u64CE\u6B63\u5728\u6DF1\u5EA6\u5206\u6790 (${this.searchDepth}\u5C64)...`}setDifficulty(e){this.searchDepth=T.DEPTHS[e],console.log(`\u{1F525} XQWLight \u5F15\u64CE\u96E3\u5EA6\u8A2D\u7F6E: ${e} (\u6DF1\u5EA6=${this.searchDepth})`)}searchRoot(e,t){let i="black",o=this.generateAllMoves(e,i);if(o.length===0)return null;let s=this.orderMoves(e,o,t),r=null,a=-T.INFINITY;for(let l of s){if(Date.now()-this.startTime>T.MAX_TIME)break;if(this.quickMoveValidation(l,e,i))continue;let c=this.simulateMove(e,l);if(this.isInvalidMoveForXQWLight(l,c,e,i))continue;let f=-this.alphaBetaSearch(c,t-1,-T.INFINITY,T.INFINITY,!1);f>a&&(a=f,r=l)}return r?{move:r,score:a}:null}alphaBetaSearch(e,t,i,o,s){if(this.nodeCount++,Date.now()-this.startTime>T.MAX_TIME)return this.evaluatePosition(e);if(t<=0)return this.evaluatePosition(e);let r=s?"black":"red",a=this.generateAllMoves(e,r);if(a.length===0)return this.isInCheck(e.board,r)?s?-T.MATE_VALUE:T.MATE_VALUE:0;let l=this.orderMoves(e,a,t);if(s){let c=-T.INFINITY;for(let f of l){let g=this.simulateMove(e,f);if(this.isInvalidMoveForXQWLight(f,g,e,r))continue;let v=this.alphaBetaSearch(g,t-1,i,o,!1);if(c=Math.max(c,v),i=Math.max(i,v),o<=i){this.recordKillerMove(t,f),this.updateHistoryTable(f,t);break}}return c}else{let c=T.INFINITY;for(let f of l){let g=this.simulateMove(e,f);if(this.isInvalidMoveForXQWLight(f,g,e,r))continue;let v=this.alphaBetaSearch(g,t-1,i,o,!0);if(c=Math.min(c,v),o=Math.min(o,v),o<=i){this.recordKillerMove(t,f),this.updateHistoryTable(f,t);break}}return c}}evaluatePosition(e){let t=0;this.isInCheck(e.board,"black")&&(t-=T.MATE_VALUE*2),this.isInCheck(e.board,"red")&&(t+=T.MATE_VALUE*2);for(let a=0;a<10;a++)for(let l=0;l<9;l++){let c=e.board[a][l];if(!c)continue;let f=oe(c.type,l,a,c.color);c.type==="king"?f+=Ue(c.position,e.board,c.color):c.type==="soldier"&&(f+=Ye(c.position,c.color));let g=G.getPieceMoves(c,e.board,!1).length;f+=je(c.type,g),c.color==="black"?t+=f:t-=f}let s=this.generateAllMoves(e,"black").length,r=this.generateAllMoves(e,"red").length;return t+=(s-r)*T.MOBILITY_FACTOR,this.isInCheck(e.board,"black")&&(t-=T.CHECK_BONUS),this.isInCheck(e.board,"red")&&(t+=T.CHECK_BONUS),t}orderMoves(e,t,i){return t.sort((o,s)=>{let r=0,a=0,l=e.board[o.to.y][o.to.x],c=e.board[s.to.y][s.to.x],f=e.board[o.from.y][o.from.x],g=e.board[s.from.y][s.from.x];if(l&&f&&(r+=ie[l.type]-ie[f.type]+Y.CAPTURE_BONUS),c&&g&&(a+=ie[c.type]-ie[g.type]+Y.CAPTURE_BONUS),this.isKillerMove(i,o)&&(r+=Y.KILLER_MOVE_BONUS),this.isKillerMove(i,s)&&(a+=Y.KILLER_MOVE_BONUS),r+=this.getHistoryScore(o),a+=this.getHistoryScore(s),f){let v=oe(f.type,o.from.x,o.from.y,f.color),y=oe(f.type,o.to.x,o.to.y,f.color);r+=(y-v)*Y.POSITION_BONUS_FACTOR}if(g){let v=oe(g.type,s.from.x,s.from.y,g.color),y=oe(g.type,s.to.x,s.to.y,g.color);a+=(y-v)*Y.POSITION_BONUS_FACTOR}return a-r})}generateAllMoves(e,t){return b.getAllLegalMoves(e,t)}simulateMove(e,t){return b.simulateMove(e,t)}isInCheck(e,t){return b.isInCheck(e,t)}wouldKingsFaceEachOther(e){return b.wouldKingsFaceEachOther(e)}getFallbackMove(e){return b.getRandomLegalMove(e,"black")}recordKillerMove(e,t){this.killerMoves.has(e)||this.killerMoves.set(e,[]);let i=this.killerMoves.get(e);i.length<2?i.push(t):(i[1]=i[0],i[0]=t)}isKillerMove(e,t){let i=this.killerMoves.get(e);return i?i.some(o=>o.from.x===t.from.x&&o.from.y===t.from.y&&o.to.x===t.to.x&&o.to.y===t.to.y):!1}updateHistoryTable(e,t){let i=`${e.from.x}${e.from.y}${e.to.x}${e.to.y}`,o=this.historyTable.get(i)||0;this.historyTable.set(i,Math.min(o+t*t,Y.HISTORY_BONUS_MAX))}getHistoryScore(e){let t=`${e.from.x}${e.from.y}${e.to.x}${e.to.y}`;return this.historyTable.get(t)||0}quickMoveValidation(e,t,i){let o=t.board,s=o[e.from.y][e.from.x];if(!s||s.color!==i)return!0;let r=o[e.to.y][e.to.x];return!!(r&&r.color===i||e.to.x<0||e.to.x>=9||e.to.y<0||e.to.y>=10)}isInvalidMoveForXQWLight(e,t,i,o){return b.isInvalidMoveForAI(e,t,i,o)}static \u0275fac=(()=>{let e;return function(i){return(e||(e=ee(n)))(i||n)}})();static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var de=class n extends q{name="ChessDB \u96F2\u5EAB";priority=0;chessService=w(j);API_BASE="https://www.chessdb.cn/chessdb.php";TIMEOUT_MS=5e3;difficulty="hard";isAvailable(){return p(this,null,function*(){try{let e=new AbortController,t=setTimeout(()=>e.abort(),2e3),i=yield fetch(`${this.API_BASE}?action=querybest&board=rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w`,{signal:e.signal,method:"GET"});return clearTimeout(t),i.ok}catch(e){return console.warn("\u26A0\uFE0F ChessDB API \u4E0D\u53EF\u7528:",e),!1}})}makeMove(e){return p(this,null,function*(){try{let t=this.chessService.convertToFEN(e);console.log(`\u{1F4E1} \u67E5\u8A62 ChessDB \u96F2\u5EAB (\u96E3\u5EA6: ${this.difficulty})...`,t);let i=yield this.queryMoveByDifficulty(t);if(!i)return console.warn("\u26A0\uFE0F ChessDB \u672A\u8FD4\u56DE\u6709\u6548\u8D70\u6CD5"),null;let o=this.parseChessDBMove(i,e);return o&&console.log("\u2705 ChessDB \u63A8\u85A6\u8D70\u6CD5:",i),o}catch(t){return console.error("\u274C ChessDB \u7B56\u7565\u932F\u8AA4:",t),null}})}getThinkingDescription(){return`\u2601\uFE0F \u67E5\u8A62\u5C08\u696D\u8C61\u68CB\u96F2\u5EAB (${{easy:"\u7C21\u55AE",medium:"\u4E2D\u7B49",hard:"\u56F0\u96E3"}[this.difficulty]})...`}setDifficulty(e){this.difficulty=e,console.log(`\u2601\uFE0F ChessDB \u96E3\u5EA6\u8A2D\u70BA: ${e}`)}queryMoveByDifficulty(e){return p(this,null,function*(){return this.difficulty==="hard"?this.queryBestMove(e):this.queryAllAndSelect(e)})}queryBestMove(e){return p(this,null,function*(){let t=new AbortController,i=setTimeout(()=>t.abort(),this.TIMEOUT_MS);try{let o=`${this.API_BASE}?action=querybest&board=${encodeURIComponent(e)}`,s=yield fetch(o,{signal:t.signal,method:"GET"});if(clearTimeout(i),!s.ok)throw new Error(`HTTP error! status: ${s.status}`);let r=yield s.text();return r.includes("move:")?r.split("move:")[1].trim():(r.includes("unknown")?console.warn("\u26A0\uFE0F ChessDB: \u4F4D\u7F6E\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D"):r.includes("checkmate")?console.log("\u{1F3C6} ChessDB: \u5DF2\u5C07\u6B7B"):r.includes("stalemate")&&console.log("\u{1F91D} ChessDB: \u548C\u5C40"),null)}catch(o){return o instanceof Error&&o.name==="AbortError"?console.warn("\u26A0\uFE0F ChessDB \u8ACB\u6C42\u8D85\u6642"):console.error("\u274C ChessDB \u8ACB\u6C42\u5931\u6557:",o),null}finally{clearTimeout(i)}})}queryAllAndSelect(e){return p(this,null,function*(){let t=new AbortController,i=setTimeout(()=>t.abort(),this.TIMEOUT_MS);try{let o=`${this.API_BASE}?action=queryall&board=${encodeURIComponent(e)}`,s=yield fetch(o,{signal:t.signal,method:"GET"});if(clearTimeout(i),!s.ok)throw new Error(`HTTP error! status: ${s.status}`);let r=yield s.text(),a=this.parseAllMoves(r);return a.length===0?(console.warn("\u26A0\uFE0F ChessDB: \u6C92\u6709\u53EF\u7528\u8D70\u6CD5"),null):this.selectMoveByDifficulty(a)}catch(o){return o instanceof Error&&o.name==="AbortError"?console.warn("\u26A0\uFE0F ChessDB \u8ACB\u6C42\u8D85\u6642"):console.error("\u274C ChessDB \u8ACB\u6C42\u5931\u6557:",o),null}finally{clearTimeout(i)}})}parseAllMoves(e){let t=[],i=e.split("|"),o={};for(let s of i){let r=s.trim();r.startsWith("move:")?(o.move&&t.push(o),o={move:r.substring(5),score:0,rank:0}):r.startsWith("score:")?o.score=parseInt(r.substring(6),10)||0:r.startsWith("rank:")&&(o.rank=parseInt(r.substring(5),10)||0)}return o.move&&t.push(o),t.filter(s=>s.move&&s.move.length>=4)}selectMoveByDifficulty(e){if(e.length===0)return null;if(e.sort((t,i)=>i.score-t.score),this.difficulty==="easy"){let t=Math.floor(e.length*.3),i=Math.floor(e.length*.5),o=e.slice(Math.max(t,0),Math.max(i,1)),s=o[Math.floor(Math.random()*o.length)];return console.log(`\u{1F3B2} \u7C21\u55AE\u6A21\u5F0F\uFF1A\u5F9E ${o.length} \u500B\u8F03\u5F31\u8D70\u6CD5\u4E2D\u9078\u64C7`),s?.move||e[0].move}else if(this.difficulty==="medium"){let t=Math.floor(e.length*.2),i=Math.floor(e.length*.4),o=e.slice(0,Math.max(i,1)),s=o[Math.floor(Math.random()*o.length)];return console.log(`\u{1F3AF} \u4E2D\u7B49\u6A21\u5F0F\uFF1A\u5F9E ${o.length} \u500B\u4E2D\u7B49\u8D70\u6CD5\u4E2D\u9078\u64C7`),s?.move||e[0].move}else return e[0].move}parseChessDBMove(e,t){if(e.length<4)return console.error("\u274C \u7121\u6548\u7684 UCI \u8D70\u6CD5\u683C\u5F0F:",e),null;let i=e.substring(0,2),o=e.substring(2,4),s=this.uciToPosition(i),r=this.uciToPosition(o);if(!s||!r)return console.error("\u274C UCI \u8D70\u6CD5\u8F49\u63DB\u5931\u6557:",e),null;let a=t.board[s.y][s.x];if(!a)return console.error("\u274C \u8D77\u9EDE\u6C92\u6709\u68CB\u5B50:",s),null;let c=this.chessService.getPossibleMoves(a,t.board).map(g=>({from:a.position,to:g}));return this.chessService.isValidMove({from:s,to:r},c)?{from:s,to:r,analysis:`ChessDB \u96F2\u5EAB\u63A8\u85A6 (${e})`}:(console.error("\u274C ChessDB \u8FD4\u56DE\u7684\u8D70\u6CD5\u4E0D\u5408\u6CD5:",{from:s,to:r}),null)}uciToPosition(e){if(e.length!==2)return null;let t=e.charCodeAt(0)-97,i=parseInt(e[1],10),o=t,s=9-i;return o<0||o>8||s<0||s>9?null:{x:o,y:s}}positionToUci(e){let t=String.fromCharCode(97+e.x),i=9-e.y;return`${t}${i}`}static \u0275fac=(()=>{let e;return function(i){return(e||(e=ee(n)))(i||n)}})();static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var xe=class n{chineseChessService=w(j);geminiStrategy=w(ce);xqwlightStrategy=w(ue);chessdbStrategy=w(de);strategies=[];enabledStrategies={chessdb:!0,xqwlight:!0,gemini:!1};constructor(){this.initializeStrategies()}initializeStrategies(){this.strategies=[this.chessdbStrategy,this.xqwlightStrategy,this.geminiStrategy]}executeAIMove(e){return p(this,null,function*(){console.log("\u{1F9E0} AI\u958B\u59CB\u601D\u8003...");let t=Date.now();try{let i=this.getEnabledStrategiesList().sort((o,s)=>o.priority-s.priority);for(let o of i){if(console.log(`\u{1F3AF} \u5617\u8A66\u7B56\u7565: ${o.name}`),!(yield o.isAvailable())){console.log(`\u26A0\uFE0F \u7B56\u7565 ${o.name} \u4E0D\u53EF\u7528\uFF0C\u5617\u8A66\u4E0B\u4E00\u500B...`);continue}let r=yield o.makeMove(e);if(r){let a=Date.now()-t;return console.log(`\u2705 \u7B56\u7565 ${o.name} \u6C7A\u7B56\u6210\u529F: ${a}ms`),console.log(`\u{1F3C6} \u9078\u64C7\u79FB\u52D5: (${r.from.x},${r.from.y}) -> (${r.to.x},${r.to.y})`),r.analysis&&console.log(`\u{1F4CA} \u5206\u6790: ${r.analysis}`),{from:r.from,to:r.to}}console.log(`\u274C \u7B56\u7565 ${o.name} \u672A\u80FD\u63D0\u4F9B\u6709\u6548\u79FB\u52D5`)}return console.log("\u{1F3B2} \u4F7F\u7528\u96A8\u6A5F\u79FB\u52D5\u4F5C\u70BA\u6700\u5F8C\u5099\u6848..."),this.getEmergencyMove(e)}catch(i){return console.error("\u{1F916} AI\u601D\u8003\u51FA\u932F:",i),this.getEmergencyMove(e)}})}getEnabledStrategiesList(){return this.strategies.filter(e=>e instanceof de?this.enabledStrategies.chessdb:e instanceof ue?this.enabledStrategies.xqwlight:e instanceof ce?this.enabledStrategies.gemini:!1)}getEmergencyMove(e){return this.chineseChessService.getRandomLegalMove(e,"black")}setChessDBEnabled(e){this.enabledStrategies.chessdb=e,console.log(`\u2601\uFE0F ChessDB \u96F2\u5EAB\u7B56\u7565: ${e?"\u555F\u7528":"\u505C\u7528"}`)}setGeminiEnabled(e){this.enabledStrategies.gemini=e,console.log(`\u{1F916} Gemini AI \u7B56\u7565: ${e?"\u555F\u7528":"\u505C\u7528"}`)}setXQWLightEnabled(e){this.enabledStrategies.xqwlight=e,console.log(`\u{1F525} XQWLight \u5C08\u696D\u5F15\u64CE: ${e?"\u555F\u7528":"\u505C\u7528"}`)}setAIMode(e){switch(e){case"chessdb-only":this.enabledStrategies={chessdb:!0,xqwlight:!1,gemini:!1},console.log("\u2601\uFE0F AI \u6A21\u5F0F: \u50C5\u4F7F\u7528 ChessDB \u96F2\u5EAB (\u6700\u5F37)");break;case"xqwlight-only":this.enabledStrategies={chessdb:!1,xqwlight:!0,gemini:!1},console.log("\u{1F525} AI \u6A21\u5F0F: \u50C5\u4F7F\u7528 XQWLight \u5F15\u64CE");break;case"gemini-only":this.enabledStrategies={chessdb:!1,xqwlight:!1,gemini:!0},console.log("\u{1F916} AI \u6A21\u5F0F: \u50C5\u4F7F\u7528 Gemini AI (\u5BE6\u9A57\u6027)");break;case"auto":default:this.enabledStrategies={chessdb:!0,xqwlight:!0,gemini:!1},console.log("\u26A1 AI \u6A21\u5F0F: \u81EA\u52D5 (ChessDB \u2192 XQWLight)");break}}setDifficulty(e){this.chessdbStrategy.setDifficulty(e),this.xqwlightStrategy.setDifficulty(e),console.log(`\u{1F3AF} \u5168\u5C40\u96E3\u5EA6\u8A2D\u7F6E\u70BA: ${e} (ChessDB + XQWLight)`)}getThinkingDescription(){return this.getEnabledStrategiesList().sort((i,o)=>i.priority-o.priority)[0]?.getThinkingDescription()||"\u{1F3B2} AI\u6B63\u5728\u9078\u64C7\u79FB\u52D5..."}getStrategyStatus(){return O({},this.enabledStrategies)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var Ae=class n{strategyService=w(xe);makeAIMove(e){return p(this,null,function*(){return this.strategyService.executeAIMove(e)})}setUseGeminiAI(e){this.strategyService.setGeminiEnabled(e)}setAIMode(e){this.strategyService.setAIMode(e)}setUseXQWLight(e){this.strategyService.setXQWLightEnabled(e)}getAIStatus(){let e=this.strategyService.getStrategyStatus();return{chessdb:e.chessdb,xqwlight:e.xqwlight,geminiAI:e.gemini}}setDifficulty(e){this.strategyService.setDifficulty(e)}getThinkingDescription(){return this.strategyService.getThinkingDescription()}getDetailedThinkingStatus(){let e=this.getAIStatus(),t="unknown",i="";return e.chessdb?(t="chessdb",i="ChessDB \u96F2\u5EAB\u601D\u8003\u4E2D..."):e.xqwlight?(t="xqwlight",i="XQWLight \u5C08\u696D\u5F15\u64CE\u601D\u8003\u4E2D..."):e.geminiAI?(t="gemini",i="Gemini AI \u601D\u8003\u4E2D..."):(t="random",i="\u96A8\u6A5F\u9078\u64C7\u4E2D..."),{description:i,mode:t,isThinking:!0}}static \u0275fac=function(t){return new(t||n)};static \u0275prov=B({token:n,factory:n.\u0275fac,providedIn:"root"})};var Dt=()=>[0,1,2,3,4,5,6,7,8,9],wt=()=>[0,1,2,3,4,5,6,7,8],ot=n=>({"valid-move-point":n});function Nt(n,e){if(n&1){let t=Se();u(0,"div",8)(1,"button",65),N("click",function(){Q(t);let o=_();return z(o.selectMode("pvp"))}),m(2," \u{1F465} \u96D9\u4EBA\u6A21\u5F0F "),h(),S(3,"div",66),u(4,"button",65),N("click",function(){Q(t);let o=_();return z(o.selectMode("easy"))}),m(5," \u{1F916} \u7C21\u55AEAI "),h(),u(6,"button",65),N("click",function(){Q(t);let o=_();return z(o.selectMode("medium"))}),m(7," \u{1F916} \u4E2D\u7B49AI "),h(),u(8,"button",65),N("click",function(){Q(t);let o=_();return z(o.selectMode("hard"))}),m(9," \u{1F916} \u56F0\u96E3AI "),h()()}if(n&2){let t=_();d(),M("ngClass",t.isVsAI()?"":"bg-lime-700"),d(3),M("ngClass",t.isVsAI()&&t.aiDifficulty()==="easy"?"bg-lime-700":""),d(2),M("ngClass",t.isVsAI()&&t.aiDifficulty()==="medium"?"bg-lime-700":""),d(2),M("ngClass",t.isVsAI()&&t.aiDifficulty()==="hard"?"bg-lime-700":"")}}function kt(n,e){n&1&&(u(0,"span"),m(1,"\u{1F916}"),h())}function Bt(n,e){if(n&1&&m(0),n&2){let t=_();R(" ",t.moveHistory()[t.moveHistory().length-1]," ")}}function Lt(n,e){n&1&&m(0," \uFF1F\uFF1F ")}function Gt(n,e){if(n&1&&(u(0,"div",31),m(1),h()),n&2){let t=e.$implicit;d(),R(" ",t," ")}}function Kt(n,e){if(n&1&&(u(0,"div",34),m(1),h()),n&2){let t=e.$implicit;d(),R(" ",t," ")}}function Ft(n,e){if(n&1&&S(0,"div",67)(1,"div",68),n&2){let t=e.$implicit;U("top",t*40+4,"px"),M("ngClass",t===6?"z-20 h-[1.5px]":"z-10"),d(),U("top",t*50+4,"px"),M("ngClass",t===6?"z-20 h-[1.5px]":"z-10")}}function $t(n,e){if(n&1&&S(0,"div",69)(1,"div",69)(2,"div",70)(3,"div",70),n&2){let t=e.$implicit;U("left",t*36+14,"px")("top",4,"px")("height",157,"px"),d(),U("left",t*36+14,"px")("top",203,"px")("height",162,"px"),d(),U("left",t*50+4,"px")("top",4,"px")("height",200,"px"),d(),U("left",t*50+4,"px")("top",254,"px")("height",200,"px")}}function Ht(n,e){n&1&&(u(0,"div",45),m(1," \u2694\uFE0F \u5C07\u8ECD\uFF01 "),h())}function Vt(n,e){n&1&&(u(0,"div",46),m(1," \u{1F6E1}\uFE0F \u88AB\u5C07\u8ECD "),h())}function Ut(n,e){n&1&&(u(0,"div",47),m(1," \u{1F916} AI\u601D\u8003\u4E2D... "),h())}function Yt(n,e){n&1&&(u(0,"div",50),m(1," \u2694\uFE0F \u5C07\u8ECD\uFF01 "),h())}function jt(n,e){n&1&&(u(0,"div",51),m(1," \u{1F6E1}\uFE0F \u88AB\u5C07\u8ECD "),h())}function qt(n,e){n&1&&(u(0,"div",52),m(1," \u{1F916} AI\u601D\u8003\u4E2D... "),h())}function Wt(n,e){n&1&&S(0,"div",72)}function Xt(n,e){n&1&&S(0,"div",72)}function Qt(n,e){if(n&1&&(u(0,"div",73)(1,"div",80),m(2),h()()),n&2){let t=_().$implicit,i=_(2);M("ngClass",i.getPieceClass(t)),d(),M("ngClass",t.color===i.PlayerColor.RED?"bg-red-100 border-red-600 text-red-800":"bg-neutral-100 border-neutral-800 text-neutral-800"),d(),R(" ",i.getPieceSymbol(t)," ")}}function zt(n,e){n&1&&S(0,"div",74)}function Jt(n,e){n&1&&S(0,"div",75)}function Zt(n,e){n&1&&S(0,"div",72)}function ei(n,e){n&1&&S(0,"div",72)}function ti(n,e){if(n&1&&(u(0,"div",77)(1,"div",81),m(2),h()()),n&2){let t=_().$implicit,i=_(2);M("ngClass",i.getPieceClass(t)),d(),M("ngClass",t.color===i.PlayerColor.RED?"bg-red-100 border-red-600 text-red-800":"bg-neutral-100 border-neutral-800 text-neutral-800"),d(),R(" ",i.getPieceSymbol(t)," ")}}function ii(n,e){n&1&&S(0,"div",78)}function oi(n,e){n&1&&S(0,"div",79)}function ni(n,e){if(n&1){let t=Se();u(0,"div",71),N("click",function(){let o=Q(t).$index,s=_().$index,r=_();return z(r.onSquareClick(o,s))}),x(1,Wt,1,0,"div",72),x(2,Xt,1,0,"div",72),x(3,Qt,3,3,"div",73),x(4,zt,1,0,"div",74),x(5,Jt,1,0,"div",75),h(),u(6,"div",76),N("click",function(){let o=Q(t).$index,s=_().$index,r=_();return z(r.onSquareClick(o,s))}),x(7,Zt,1,0,"div",72),x(8,ei,1,0,"div",72),x(9,ti,3,3,"div",77),x(10,ii,1,0,"div",78),x(11,oi,1,0,"div",79),h()}if(n&2){let t=e.$implicit,i=e.$index,o=_().$index,s=_();U("top",o*40+4,"px")("left",i*36+14,"px"),M("ngClass",Te(20,ot,s.isValidMove(i,o))),d(),A((o===2||o===7)&&(i===0||i===2||i===4||i===6||i===8)?1:-1),d(),A((o===3||o===6)&&(i===1||i===7)?2:-1),d(),A(t?3:-1),d(),A(s.isValidMove(i,o)&&!t?4:-1),d(),A(s.isValidMove(i,o)&&t&&t.color!==s.currentPlayer()?5:-1),d(),U("top",o*50+4,"px")("left",i*50+4,"px"),M("ngClass",Te(22,ot,s.isValidMove(i,o))),d(),A((o===2||o===7)&&(i===0||i===2||i===4||i===6||i===8)?7:-1),d(),A((o===3||o===6)&&(i===1||i===7)?8:-1),d(),A(t?9:-1),d(),A(s.isValidMove(i,o)&&!t?10:-1),d(),A(s.isValidMove(i,o)&&t&&t.color!==s.currentPlayer()?11:-1)}}function si(n,e){if(n&1&&K(0,ni,12,24,null,null,fe),n&2){let t=e.$implicit;F(t)}}function ri(n,e){if(n&1&&(u(0,"div",34),m(1),h()),n&2){let t=e.$implicit;d(),R(" ",t," ")}}function ai(n,e){if(n&1&&(u(0,"div",31),m(1),h()),n&2){let t=e.$implicit;d(),R(" ",t," ")}}function li(n,e){if(n&1&&(u(0,"p",58),m(1),h()),n&2){let t=_();d(),R(" ",t.gameState().status.winReason," ")}}function ci(n,e){n&1&&(u(0,"p",61),m(1,"\u5C1A\u7121\u68CB\u8B5C\u8A18\u9304"),h())}function ui(n,e){if(n&1&&(u(0,"span",86),m(1),h()),n&2){let t=_(2).$index,i=_(2);d(),te(i.moveHistory()[t+1])}}function di(n,e){if(n&1&&(u(0,"div")(1,"span",83),m(2),h(),u(3,"div",84)(4,"span",85),m(5),h(),x(6,ui,2,1,"span",86),h()()),n&2){let t=_(),i=t.$implicit,o=t.$index,s=_(2);Be(Le("flex gap-3 py-2 px-3 rounded ",o===s.moveHistory().length-2||o===s.moveHistory().length-1?"bg-neutral-800":"hover:bg-neutral-800")),d(2),R("",s.Math.floor(o/2)+1,"."),d(3),te(i),d(),A(s.moveHistory()[o+1]?6:-1)}}function hi(n,e){if(n&1&&x(0,di,7,6,"div",82),n&2){let t=e.$index;A(t%2===0?0:-1)}}function fi(n,e){if(n&1&&(u(0,"div",62),K(1,hi,1,1,null,null,fe),h()),n&2){let t=_();d(),F(t.moveHistory())}}var nt=class n{chineseChessService=w(j);chineseChessAiService=w(Ae);seoService=w(He);apiKeyUpdateListener;lastSelectedPiece=null;gameState=V(Re);aiType=V("local");board=I(()=>this.gameState().board);currentPlayer=I(()=>this.gameState().currentPlayer);selectedPiece=I(()=>this.gameState().selectedPiece);validMoves=I(()=>this.gameState().validMoves);moveHistory=I(()=>this.gameState().moveHistory);gameOver=I(()=>this.gameState().status.gameOver);winner=I(()=>this.gameState().status.winner);isInCheck=I(()=>this.gameState().status.isInCheck);isCheckmate=I(()=>this.gameState().status.isCheckmate);isStalemate=I(()=>this.gameState().status.isStalemate);isSelfInCheck=I(()=>this.gameState().status.isSelfInCheck);currentPlayerDisplay=I(()=>this.currentPlayer()==="red"?"\u7D05\u65B9":"\u9ED1\u65B9");isVsAI=I(()=>this.gameState().isVsAI);aiIsThinking=I(()=>this.gameState().aiState.isThinking);aiThinkingText=I(()=>this.gameState().aiState.thinkingText);aiDifficulty=V("medium");hasApiKey=I(()=>this.chineseChessService.hasApiKey());isGeminiEnabled=I(()=>this.hasApiKey()&&this.isVsAI());isApiKeyModalOpen=V(!1);isDropdownOpen=V(!1);isMoveHistoryModalOpen=V(!1);isAITurn=I(()=>this.isVsAI()&&this.currentPlayer()==="black"&&!this.gameOver());canInteract=I(()=>!this.isVsAI()||this.currentPlayer()==="red");PlayerColor=L;Math=Math;gameRules={title:"\u4E2D\u570B\u8C61\u68CB\u904A\u6232\u898F\u5247",rules:["\u9EDE\u64CA\u9078\u64C7\u68CB\u5B50\uFF0C\u518D\u9EDE\u64CA\u76EE\u6A19\u4F4D\u7F6E\u79FB\u52D5","\u7D05\u65B9\u5148\u884C\uFF0C\u96D9\u65B9\u8F2A\u6D41\u4E0B\u68CB","\u5C07\u8ECD\u5C0D\u65B9\u7684\u5C07/\u5E25\u5373\u7372\u52DD","\u5C07/\u5E25\u4E0D\u80FD\u96E2\u958B\u4E5D\u5BAE\u683C\u7BC4\u570D","\u5175/\u5352\u904E\u6CB3\u5F8C\u53EF\u6A6B\u5411\u79FB\u52D5","\u99AC\u8D70\u65E5\u5B57\u4E14\u4E0D\u80FD\u8E69\u817F","\u8C61/\u76F8\u8D70\u7530\u5B57\u4E14\u4E0D\u80FD\u904E\u6CB3","\u8ECA\u8D70\u76F4\u7DDA\uFF0C\u7832\u9694\u5B50\u5403\u68CB"]};ngOnInit(){this.seoService.updateSeoTags({title:"\u4E2D\u570B\u8C61\u68CB",description:"\u7D93\u5178\u4E2D\u570B\u8C61\u68CB\u5C0D\u5F08\u5E73\u53F0\uFF01\u5B8C\u6574\u5BE6\u4F5C\u8C61\u68CB\u898F\u5247,\u642D\u8F09\u5C08\u696DXQWLight\u5F15\u64CEAI,\u652F\u63F4\u591A\u7A2E\u96E3\u5EA6\u3002\u9AD4\u9A57\u771F\u5BE6\u7684\u4E2D\u570B\u8C61\u68CB\u5C0D\u6230,\u652F\u63F4\u4EBA\u4EBA\u5C0D\u6230\u548C\u4EBA\u6A5F\u5C0D\u6230\u6A21\u5F0F\u3002",keywords:"\u4E2D\u570B\u8C61\u68CB,\u8C61\u68CB\u904A\u6232,\u7DDA\u4E0A\u8C61\u68CB,\u8C61\u68CBAI,Chinese Chess,\u7B56\u7565\u904A\u6232,\u68CB\u985E\u904A\u6232,\u514D\u8CBB\u8C61\u68CB",type:"game",url:"https://mtwmt.com/game/chinese-chess",canonical:"https://mtwmt.com/game/chinese-chess"}),this.resetGame(),this.chineseChessService.updateApiKeyStatus(),this.chineseChessAiService.setAIMode("auto"),this.chineseChessAiService.setDifficulty(this.aiDifficulty()),typeof window<"u"&&(this.apiKeyUpdateListener=()=>{this.chineseChessService.updateApiKeyStatus(),this.hasApiKey()&&this.aiType()==="local"&&this.setAIType("service")},window.addEventListener("gemini_api_key_updated",this.apiKeyUpdateListener),document.addEventListener("click",e=>{!e.target.closest(".dropdown-container")&&this.isDropdownOpen()&&this.closeDropdown()}))}ngOnDestroy(){typeof window<"u"&&this.apiKeyUpdateListener&&window.removeEventListener("gemini_api_key_updated",this.apiKeyUpdateListener)}resetGame(){let e=this.chineseChessService.initializeGameState();this.gameState.set(e)}onSquareClick(e,t){if(this.gameOver()||!this.canInteract())return;let i=this.gameState(),o=i.board[t][e];i.selectedPiece?this.handleSelectedPieceClick(e,t,o,i):this.handleInitialPieceClick(o)}handleSelectedPieceClick(e,t,i,o){i&&i.color===o.currentPlayer&&i!==o.selectedPiece?this.selectPiece(i):this.isValidMove(e,t)?this.makeMove(o.selectedPiece.position,{x:e,y:t}):this.deselectPiece()}handleInitialPieceClick(e){let t=this.gameState();e&&e.color===t.currentPlayer&&this.selectPiece(e)}selectPiece(e){let t=this.gameState();this.lastSelectedPiece&&(this.lastSelectedPiece.isSelected=!1),e.isSelected=!0,this.lastSelectedPiece=e;let i=this.chineseChessService.getPossibleMoves(e,t.board);this.gameState.set(D(O({},t),{selectedPiece:e,validMoves:i}))}deselectPiece(){let e=this.gameState();this.lastSelectedPiece&&(this.lastSelectedPiece.isSelected=!1,this.lastSelectedPiece=null),this.gameState.set(D(O({},e),{selectedPiece:null,validMoves:[]}))}isValidMove(e,t){return this.validMoves().some(i=>i.x===e&&i.y===t)}makeMove(e,t){let i=this.gameState(),o=i.board[e.y][e.x];if(!o)return;let s=this.chineseChessService.makeMove(i,e,t);s.success&&this.processMoveResult(s,o,e,t,i)}processMoveResult(e,t,i,o,s){let r=this.generateMoveNotation(t,i,o,e.captured),a=[...s.moveHistory,r],l=this.getNextPlayer(s.currentPlayer),c=this.evaluateGameResult(e,s);this.clearPieceSelections(s),this.updateGameState(s,l,a,c),this.checkAndTriggerAIMove(c.gameOver,s.isVsAI,l)}getNextPlayer(e){return e==="red"?"black":"red"}evaluateGameResult(e,t){return e.status}clearPieceSelections(e){e.board.flat().forEach(t=>{t&&(t.isSelected=!1)})}updateGameState(e,t,i,o){this.gameState.set(D(O({},e),{currentPlayer:t,selectedPiece:null,validMoves:[],moveHistory:i,status:o}))}checkAndTriggerAIMove(e,t,i){console.log("\u6AA2\u67E5AI\u89F8\u767C\u689D\u4EF6:",{gameOver:e,isVsAI:t,nextPlayer:i,shouldTrigger:!e&&t&&i==="black"}),!e&&t&&i==="black"&&(console.log("\u6E96\u5099\u89F8\u767CAI\u79FB\u52D5..."),this.triggerAIMove())}generateMoveNotation(e,t,i,o){if(!e)return"";let s=this.chineseChessService.getPieceSymbol(e),r=this.getFileNumber(e.color,t.x),a=this.getMoveAction(e.color,t,i);return`${s}${this.toChineseNum(r)}${a}`}toChineseNum(e){let t=["\u4E00","\u4E8C","\u4E09","\u56DB","\u4E94","\u516D","\u4E03","\u516B","\u4E5D"];return e>=1&&e<=9?t[e-1]:e.toString()}getFileNumber(e,t){return e==="red"?9-t:t+1}getMoveAction(e,t,i){let o=i.y-t.y;if(o===0){let s=this.getFileNumber(e,i.x);return"\u5E73"+this.toChineseNum(s)}else return(this.isMoveForward(e,o)?"\u9032":"\u9000")+this.toChineseNum(Math.abs(o))}isMoveForward(e,t){return e==="red"&&t<0||e==="black"&&t>0}getSquareClass(e,t){let i="chess-square";return this.board()[t]?.[e]?.isSelected&&(i+=" selected"),this.isValidMove(e,t)&&(i+=" valid-move"),(this.chineseChessService.isInPalace(e,t,"red")||this.chineseChessService.isInPalace(e,t,"black"))&&(i+=" palace"),i}getPieceClass(e){if(!e)return"";let t=`chess-piece ${e.color}`;return e.isSelected&&(t+=" selected"),t}getPieceSymbol(e){return e?this.chineseChessService.getPieceSymbol(e):""}getRowNumbers(){return Array.from({length:10},(e,t)=>10-t)}getColumnLetters(){return["a","b","c","d","e","f","g","h","i"]}toggleGameMode(){let e=this.gameState(),t=!e.isVsAI;this.gameState.set(D(O({},e),{isVsAI:t,aiState:{isThinking:!1,thinkingText:""}})),t&&e.currentPlayer==="black"&&!e.status.gameOver&&this.triggerAIMove()}triggerAIMove(){return p(this,null,function*(){let e=this.gameState();console.log("\u{1F916} \u89F8\u767CAI\u79FB\u52D5\uFF0C\u7576\u524D\u73A9\u5BB6:",e.currentPlayer),this.prepareAIThinking(e),setTimeout(()=>p(this,null,function*(){try{yield this.executeAIMove(e)}catch(t){console.error("\u{1F916} AI\u79FB\u52D5\u51FA\u932F:",t),this.aiSurrender()}}),C.AI_THINKING_DELAY)})}prepareAIThinking(e){this.chineseChessAiService.setDifficulty(this.aiDifficulty()),this.gameState.set(D(O({},e),{aiState:{isThinking:!0,thinkingText:this.chineseChessAiService.getThinkingDescription()}}))}executeAIMove(e){return p(this,null,function*(){let t=yield this.chineseChessAiService.makeAIMove(e);t?(console.log("\u{1F916} AI\u9078\u64C7\u79FB\u52D5:",t),this.makeAIMove(t.from,t.to)):(console.warn("\u{1F916} AI\u7121\u6CD5\u627E\u5230\u6709\u6548\u79FB\u52D5\uFF0CAI\u6295\u964D"),this.aiSurrender())})}makeAIMove(e,t){let i=this.gameState(),o=i.board[e.y][e.x];if(!o)return;let s=this.chineseChessService.makeMove(i,e,t);s.success&&this.processAIMoveResult(s,o,e,t,i)}processAIMoveResult(e,t,i,o,s){let r=this.generateMoveNotation(t,i,o,e.captured),a=[...s.moveHistory,r],l=this.getNextPlayer(t.color),c=this.evaluateGameResult(e,s),f=e.status.winner;this.clearPieceSelections(s),this.gameState.set(D(O({},s),{currentPlayer:l,selectedPiece:null,validMoves:[],moveHistory:a,status:c,aiState:{isThinking:!1,thinkingText:""}}))}aiSurrender(){let e=this.gameState();console.log("\u{1F916} AI\u6295\u964D\uFF0C\u904A\u6232\u7D50\u675F"),this.gameState.set(D(O({},e),{status:{gameOver:!0,winner:"red",winReason:"AI \u6295\u964D",isInCheck:!1,isSelfInCheck:!1,isCheckmate:!1,isStalemate:!1},aiState:{isThinking:!1,thinkingText:""},moveHistory:[...e.moveHistory,"\u{1F916} AI\u6295\u964D"]}))}setAIDifficulty(e){this.aiDifficulty.set(e),this.chineseChessAiService.setDifficulty(e),console.log("\u{1F916} AI\u96E3\u5EA6\u8A2D\u7F6E\u70BA:",e)}getAIDifficultyText(){switch(this.aiDifficulty()){case"easy":return"\u7C21\u55AE";case"medium":return"\u4E2D\u7B49";case"hard":return"\u56F0\u96E3";default:return"\u4E2D\u7B49"}}getCurrentModeText(){return this.isVsAI()?`\u{1F916} ${this.getAIDifficultyText()}AI`:"\u{1F465} \u96D9\u4EBA\u6A21\u5F0F"}toggleDropdown(){this.isDropdownOpen.set(!this.isDropdownOpen())}closeDropdown(){this.isDropdownOpen.set(!1)}openMoveHistoryModal(){this.isMoveHistoryModalOpen.set(!0)}closeMoveHistoryModal(){this.isMoveHistoryModalOpen.set(!1)}selectMode(e){e==="pvp"?this.isVsAI()&&this.toggleGameMode():(this.isVsAI()||this.toggleGameMode(),this.setAIDifficulty(e)),this.closeDropdown()}openApiKeyModal(){this.isApiKeyModalOpen.set(!0)}closeApiKeyModal(){this.isApiKeyModalOpen.set(!1)}clearApiKey(){typeof localStorage<"u"&&localStorage.removeItem("gemini-api-key"),this.chineseChessService.updateApiKeyStatus(),this.aiType()==="service"&&this.setAIType("local"),console.log("Gemini API Key \u5DF2\u6E05\u9664")}onApiKeySaved(){console.log("onApiKeySaved called"),this.chineseChessService.updateApiKeyStatus(),console.log("hasApiKey after save:",this.hasApiKey()),setTimeout(()=>{this.closeApiKeyModal()},100)}onApiKeyCleared(){console.log("onApiKeyCleared called"),this.chineseChessService.updateApiKeyStatus(),console.log("hasApiKey after clear:",this.hasApiKey()),this.aiType()==="service"&&this.setAIType("local"),setTimeout(()=>{this.closeApiKeyModal()},100)}setAIType(e){this.aiType.set(e),e==="service"&&!this.hasApiKey()&&this.openApiKeyModal(),this.chineseChessAiService.setUseGeminiAI(e==="service"),console.log(`\u{1F916} \u5DF2\u5207\u63DB AI \u985E\u578B: ${e}`)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=ke({type:n,selectors:[["app-chinese-chess"]],decls:115,vars:30,consts:[[1,"w-full","max-w-sm","mx-auto","flex","flex-col"],[1,"mb-2","flex","flex-col","gap-3","items-stretch"],["title","\u4E2D\u570B\u8C61\u68CB",3,"gameRules"],[1,"flex","gap-2","justify-between"],[1,"relative","w-2/4","dropdown-container"],[1,"h-12","w-full","rounded-md","bg-lime-700","border","border-lime-500","text-lime-50","font-semibold","text-sm","shadow","hover:bg-lime-600","focus:outline-none","focus:ring-2","focus:ring-lime-300","drop-shadow-[0_0_5px_#22d3ee]","flex","items-center","justify-between","px-3","transition-all","hover:shadow-lg",3,"click"],[1,"flex","items-center","gap-1"],[1,"text-lime-200","font-bold","transition-transform","duration-200"],[1,"absolute","top-14","left-0","w-full","bg-neutral-800","border","border-neutral-600","rounded-md","shadow-lg","z-50"],[1,"h-12","w-1/4","rounded-md","bg-cyan-700","border","border-cyan-500","text-cyan-50","font-semibold","text-base","shadow","hover:bg-cyan-600","focus:outline-none","focus:ring-2","focus:ring-cyan-300",3,"click"],[1,"flex","flex-col","gap-2"],[1,"flex","items-center","justify-center","gap-1","flex-wrap","bg-white/10","rounded-md","p-2","border","border-white/20"],[1,"border","border-lime-400","bg-lime-400/20","px-2","py-1","text-lime-300","font-bold","hover:bg-lime-400/30","transition"],[1,"text-lime-400","text-xs"],[1,"text-center","text-xs"],[1,"border","px-2","py-1","font-bold",3,"ngClass"],[1,"text-xs"],[1,"border","border-amber-400","bg-amber-400/20","px-2","py-1","text-amber-300","font-bold"],[1,"text-amber-400","text-xs"],[1,"border","border-green-400","bg-green-400/20","px-2","py-1","text-green-300","font-bold","text-center"],[1,"text-green-400","text-xs"],["title","\u67E5\u770B\u68CB\u8B5C\u8A18\u9304",1,"border","border-cyan-400","bg-cyan-400/20","px-2","py-1","text-cyan-300","font-bold","hover:bg-cyan-400/30","transition-all","duration-200","relative",3,"click"],[1,"text-cyan-400","text-xs"],[1,"text-center","text-xs","flex","items-center","justify-center","gap-1"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-3","h-3"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"],[1,"flex","justify-center"],[1,"relative","inline-block"],[1,"bg-amber-100","border-2","sm:border-4","border-amber-800","p-2","sm:p-6","relative"],[1,"flex","justify-center","mb-2","sm:mb-6"],[1,"grid","grid-cols-9","gap-0"],[1,"w-[36px]","sm:w-[50px]","text-center","text-xs","font-bold","text-amber-800"],[1,"flex"],[1,"flex","flex-col","mr-1","sm:mr-2","relative","-top-4"],[1,"h-[40px]","sm:h-[50px]","flex","items-center","justify-center","text-xs","font-bold","text-amber-800","w-4","sm:w-6"],[1,"relative","w-[310px]","h-[360px]","sm:w-[408px]","sm:h-[454px]","bg-amber-100"],["viewBox","0 0 100 100",1,"absolute","top-0","left-[122px]","w-[72px]","h-[80px]","sm:hidden"],["x1","0","y1","0","x2","100","y2","100","stroke","#d97706","stroke-width","1"],["x1","100","y1","0","x2","0","y2","100","stroke","#d97706","stroke-width","1"],["viewBox","0 0 100 100",1,"absolute","bottom-0","left-[122px]","w-[72px]","h-[80px]","sm:hidden"],["viewBox","0 0 100 100",1,"absolute","top-1","left-[154px]","w-[100px]","h-[100px]","hidden","sm:block"],["viewBox","0 0 100 100",1,"absolute","bottom-0","left-[154px]","w-[100px]","h-[100px]","hidden","sm:block"],[1,"absolute","left-0","right-0","bg-amber-100","flex","items-center","justify-between","px-4","z-5","sm:hidden",2,"top","161px","height","40px"],[1,"text-amber-700","font-bold","text-xs","tracking-wider"],[1,"flex","items-center","justify-center","gap-1"],[1,"text-lg","text-red-600","font-bold","animate-pulse","drop-shadow-md"],[1,"text-lg","text-orange-600","font-bold","animate-pulse","drop-shadow-md"],[1,"text-xs","text-blue-600","font-bold","animate-pulse","drop-shadow-md"],[1,"absolute","left-0","right-0","bg-amber-100","flex","items-center","justify-between","px-8","z-5","hidden","sm:flex",2,"top","204px","height","50px"],[1,"text-amber-700","font-bold","text-sm","tracking-wider"],[1,"text-xl","text-red-600","font-bold","animate-pulse","drop-shadow-lg"],[1,"text-xl","text-orange-600","font-bold","animate-pulse","drop-shadow-lg"],[1,"text-sm","text-blue-600","font-bold","animate-pulse","drop-shadow-lg"],[1,"flex","flex-col","ml-1","sm:ml-2","relative","-top-4"],[1,"flex","justify-center","mt-2","sm:mt-3","absolute","bottom-[8px]","left-[22px]","sm:bottom-[22px]","sm:left-[36px]"],["theme","amber",3,"close","isOpen","showCloseButton","closeOnBackdrop"],[1,"text-3xl","mb-4"],[1,"text-2xl","font-bold","mb-2","text-amber-100"],[1,"text-lg","mb-4","text-amber-200"],[1,"bg-amber-400","hover:bg-amber-300","text-amber-900","font-bold","py-3","px-6","rounded-lg","transition-all","duration-200","transform","hover:scale-105","shadow-lg",3,"click"],["title","\u68CB\u8B5C\u8A18\u9304","size","sm",3,"close","isOpen","type","hasFooter"],[1,"text-neutral-400","text-center"],[1,"grid","grid-cols-1","gap-2","text-sm"],["slot","footer"],[1,"text-xs","text-neutral-500"],[1,"w-full","px-3","py-2","text-left","text-sm","text-white","hover:bg-neutral-700","flex","items-center","gap-2",3,"click","ngClass"],[1,"border-t","border-neutral-600"],[1,"absolute","left-0","right-0","h-[1px]","bg-amber-800","sm:hidden",3,"ngClass"],[1,"absolute","left-0","right-0","h-[1px]","bg-amber-800","hidden","sm:block",3,"ngClass"],[1,"absolute","w-[1px]","bg-amber-800","sm:hidden"],[1,"absolute","w-[1px]","bg-amber-800","hidden","sm:block"],[1,"absolute","w-[20px]","h-[20px]","-translate-x-1/2","-translate-y-1/2","rounded-full","hover:bg-amber-200/30","cursor-pointer","z-20","sm:hidden",3,"click","ngClass"],[1,"absolute","w-[6px]","h-[6px]","bg-amber-800","rounded-full","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-[32px]","h-[32px]",3,"ngClass"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-2","h-2","bg-green-500","rounded-full","opacity-70"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-[34px]","h-[34px]","border-2","border-red-500","rounded-full"],[1,"absolute","w-[24px]","h-[24px]","-translate-x-1/2","-translate-y-1/2","rounded-full","hover:bg-amber-200/30","cursor-pointer","z-20","hidden","sm:block",3,"click","ngClass"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-[40px]","h-[40px]",3,"ngClass"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-3","h-3","bg-green-500","rounded-full","opacity-70"],[1,"absolute","top-1/2","left-1/2","-translate-x-1/2","-translate-y-1/2","w-[42px]","h-[42px]","border-2","border-red-500","rounded-full"],[1,"w-8","h-8","rounded-full","border-2","flex","items-center","justify-center","text-sm","font-bold","shadow-lg",3,"ngClass"],[1,"w-10","h-10","rounded-full","border-2","flex","items-center","justify-center","text-lg","font-bold","shadow-lg",3,"ngClass"],[3,"class"],[1,"text-neutral-400","min-w-[2rem]","font-mono"],[1,"flex","gap-4","flex-1"],[1,"text-red-400","min-w-[4rem]"],[1,"text-neutral-300"]],template:function(t,i){t&1&&(u(0,"div",0)(1,"header",1),S(2,"app-game-header",2),u(3,"div",3)(4,"div",4)(5,"button",5),N("click",function(){return i.toggleDropdown()}),u(6,"span"),m(7),h(),u(8,"div",6)(9,"span",7),m(10," \u25BC "),h()()(),x(11,Nt,10,4,"div",8),h(),u(12,"button",9),N("click",function(){return i.resetGame()}),m(13," \u91CD\u65B0\u958B\u59CB "),h()(),u(14,"div",10)(15,"div",11)(16,"div",12)(17,"div",13),m(18,"\u7576\u524D\u5C0D\u6230"),h(),u(19,"div",14),m(20),h()(),u(21,"div",15)(22,"div",16),m(23,"\u7576\u524D\u56DE\u5408"),h(),u(24,"div",14),x(25,kt,2,0,"span"),m(26),h()(),u(27,"div",17)(28,"div",18),m(29,"\u6700\u5F8C\u4E00\u6B65"),h(),u(30,"div",14),x(31,Bt,1,1)(32,Lt,1,0),h()(),u(33,"div",19)(34,"div",20),m(35,"\u76EE\u524D\u96E3\u5EA6"),h(),u(36,"div",14),m(37),h()(),u(38,"button",21),N("click",function(){return i.openMoveHistoryModal()}),u(39,"div",22),m(40,"\u68CB\u8B5C\u8A18\u9304"),h(),u(41,"div",23),Ee(),u(42,"svg",24),S(43,"path",25),h(),Ie(),u(44,"span"),m(45),h()()()()()(),u(46,"main",26)(47,"div",27)(48,"div",28)(49,"div",29)(50,"div",30),K(51,Gt,2,1,"div",31,J),h()(),u(53,"div",32)(54,"div",33),K(55,Kt,2,1,"div",34,J),h(),u(57,"div",35),K(58,Ft,2,6,null,null,J),K(60,$t,4,24,null,null,J),Ee(),u(62,"svg",36),S(63,"line",37)(64,"line",38),h(),u(65,"svg",39),S(66,"line",37)(67,"line",38),h(),u(68,"svg",40),S(69,"line",37)(70,"line",38),h(),u(71,"svg",41),S(72,"line",37)(73,"line",38),h(),Ie(),u(74,"div",42)(75,"span",43),m(76,"\u695A\u6CB3"),h(),u(77,"div",44),x(78,Ht,2,0,"div",45)(79,Vt,2,0,"div",46),x(80,Ut,2,0,"div",47),h(),u(81,"span",43),m(82,"\u6F22\u754C"),h()(),u(83,"div",48)(84,"span",49),m(85,"\u695A\u6CB3"),h(),u(86,"div",44),x(87,Yt,2,0,"div",50)(88,jt,2,0,"div",51),x(89,qt,2,0,"div",52),h(),u(90,"span",49),m(91,"\u6F22\u754C"),h()(),K(92,si,2,0,null,null,fe),h(),u(94,"div",53),K(95,ri,2,1,"div",34,J),h()(),u(97,"div",54)(98,"div",30),K(99,ai,2,1,"div",31,J),h()()(),u(101,"app-modal",55),N("close",function(){return i.resetGame()}),u(102,"div",56),m(103,"\u{1F3C6}"),h(),u(104,"h2",57),m(105),h(),x(106,li,2,1,"p",58),u(107,"button",59),N("click",function(){return i.resetGame()}),m(108," \u91CD\u65B0\u958B\u59CB "),h()()()(),u(109,"app-modal",60),N("close",function(){return i.closeMoveHistoryModal()}),x(110,ci,2,0,"p",61)(111,fi,3,0,"div",62),u(112,"div",63)(113,"p",64),m(114),h()()()()),t&2&&(d(2),M("gameRules",i.gameRules),d(3),Pe("bg-lime-600",i.isDropdownOpen()),d(2),te(i.getCurrentModeText()),d(2),Pe("rotate-180",i.isDropdownOpen()),d(2),A(i.isDropdownOpen()?11:-1),d(9),te(i.isVsAI()?"\u{1F916}":"\u{1F465}"),d(),M("ngClass",i.currentPlayer()===i.PlayerColor.RED?"bg-red-500/20 border-red-400 text-red-300":"bg-neutral-800/20 border-neutral-400 text-neutral-300"),d(4),A(i.isVsAI()&&i.currentPlayer()===i.PlayerColor.BLACK?25:-1),d(),R("",i.currentPlayerDisplay()," "),d(5),A(i.moveHistory().length>0?31:32),d(6),R(" ",i.getAIDifficultyText()," "),d(8),te(i.moveHistory().length),d(6),F(i.getColumnLetters()),d(4),F(i.getRowNumbers()),d(3),F(Me(28,Dt)),d(2),F(Me(29,wt)),d(18),A(i.isInCheck()?78:i.isSelfInCheck()?79:-1),d(2),A(i.aiIsThinking()?80:-1),d(7),A(i.isInCheck()?87:i.isSelfInCheck()?88:-1),d(2),A(i.aiIsThinking()?89:-1),d(3),F(i.board()),d(3),F(i.getRowNumbers()),d(4),F(i.getColumnLetters()),d(2),M("isOpen",i.gameOver())("showCloseButton",!1)("closeOnBackdrop",!1),d(4),R(" ",i.winner()===i.PlayerColor.RED?"\u7D05\u65B9\u7372\u52DD\uFF01":"\u9ED1\u65B9\u7372\u52DD\uFF01"," "),d(),A(i.gameState().status.winReason?106:-1),d(3),M("isOpen",i.isMoveHistoryModalOpen())("type","card")("hasFooter",!0),d(),A(i.moveHistory().length===0?110:111),d(4),R("\u5171 ",i.moveHistory().length," \u6B65\u68CB"))},dependencies:[Ke,Ge,Ve,$e,Fe],encapsulation:2,changeDetection:0})};export{nt as ChineseChess};
